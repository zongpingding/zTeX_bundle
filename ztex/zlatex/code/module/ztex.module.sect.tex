\ProvidesExplFile{ztex.module.sect.tex}
  {2025/09/11}{\ztex@versi@n}
  {sect~module~for~ztex}


%%%%%             sect module for ztex          %%%%%
%%% REFERENCE: 
% 1. https://github.com/Sophanatprime/cus/blob/main/module/cus.module.struct.tex
% 2. https://github.com/CTeX-org/ctex-kit/blob/master/ctex/ctex.dtx
% 3. https://github.com/jbezos/titlesec


%%%%%      disable 'sect' module scope begin    %%%%%
% ==> disable 'section' module
\bool_if:NF \g__ztex_sect_load_bool 
  { \file_input_stop: }


% ==> disable 'titlesec', 'titletoc', 'etoc' etc ...
\ztex_msg_set:nn { zsect@disable }
  {
    You~can~NOT~use~'sect'~module~together~with~
    'titlesec',~'titletoc',~'titleps',~'sectsty',~
    'tocloft',~'etoc',~'cus',~'koma-script~sub-packages'~etc~...
  }
\cs_new:Npn \__zsect_package_disable_error:
  {
    \msg_fatal:nn { ztex } { zsect@disable }
    \file_input_stop:
  }
\cs_new:Npn \zsect_package_disable_error:
  {
    \@ifpackageloaded{ scrextend}{ \__zsect_package_disable_error: }{}
    \@ifpackageloaded{ titlesec }{ \__zsect_package_disable_error: }{}
    \@ifpackageloaded{ titletoc }{ \__zsect_package_disable_error: }{}
    \@ifpackageloaded{  titleps }{ \__zsect_package_disable_error: }{}
    \@ifpackageloaded{  sectsty }{ \__zsect_package_disable_error: }{}
    \@ifpackageloaded{  tocloft }{ \__zsect_package_disable_error: }{}
    \@ifpackageloaded{   etoc   }{ \__zsect_package_disable_error: }{}
    \@ifpackageloaded{    cus   }{ \__zsect_package_disable_error: }{}
  }
\ztex_hook_preamble_last:n 
  {
    \zsect_package_disable_error:
  }



% ----------------------------------------------------------------------
%                           sect module init
% ----------------------------------------------------------------------
\__ztool_load_library:n { file-io }

\newdimen\zsect@dim@a
\newdimen\zsect@dim@b
\newdimen\zsect@dim@c
\box_new:N \l__ztoc_name_box
\box_new:N \l__ztoc_title_box
\scan_new:N \s__ztoc_ignore_empty_mark

\tl_new:N \l__zsect_level_keyval_tl
\tl_new:N \l__zsect_level_clist_tl
\tl_new:N \l__zsect_level_tl
\int_new:N \g_zsect_level_int
\int_new:N \l__zsect_class_type_int
\int_set:Nn \l__zsect_class_type_int { 0 }
\prop_new:N \c_ztoc_special_level_prop
\clist_new:N \l__zsect_potential_class_clist
\clist_new:N \g__zsect_mark_user_clist
\cs_generate_variant:Nn \cs_set:Npn { Npo }


% ==> generate sect title/toc class data
% * \g_zsect_level_int (total level amount, for future use)
% * \c_zsect_level_prop
% * \c_ztoc_special_level_prop / \c_ztoc_special_level_clist 
% * \c_zsect_level_clist
% * \c_zsect_level_tl
\clist_set:Nn \l__zsect_potential_class_clist
  {
    volume,  book, part, chapter, 
    section, subsection, subsubsection, 
    paragraph, subparagraph,
  }
\cs_new:Npn \__zsect_getcur_title_class:n #1
  { 
    \cs_if_exist:cT { #1 }
      {
        \int_incr:N \l__zsect_class_type_int
        \tl_put_right:Ne \l__zsect_level_keyval_tl
          { #1 = \int_use:N \l__zsect_class_type_int, }
        \tl_put_right:Ne \l__zsect_level_clist_tl { #1, }
        \tl_put_right:Ne \l__zsect_level_tl { {#1} }
      }
  }
\clist_map_function:NN \l__zsect_potential_class_clist
  \__zsect_getcur_title_class:n
% sec class prop
\exp_args:NNo \prop_const_from_keyval:Nn \c_zsect_level_prop
  {
    \l__zsect_level_keyval_tl
  }
% sec class clist
\clist_const:Ne \c_zsect_level_clist { \l__zsect_level_clist_tl }
% sec class tl
\tl_const:Ne \c_zsect_level_tl  { \l__zsect_level_tl }
% sec class int
\int_gset:Nn \g_zsect_level_int { \l__zsect_class_type_int }
% special sec class prop
\clist_const:Nn \c_ztoc_special_level_clist
  {
    figure, table, theorem, 
    algorithm, glossary, lstlisting,
  }
% NOTE: these special class name is depending on 
%       the '\@captype' defined by '\caption'.
\prop_gset_from_keyval:Nn \c_ztoc_special_level_prop 
  {
    figure     = 3,
    table      = 3,
    theorem    = 3,
    algorithm  = 3,
    glossary   = 3,
    lstlisting = 3,
  }
\clist_const:Nn \c_ztoc_table_types_clist
  { 
    toc,  % table of contents
    lot,  % list  of tables
    lof,  % list  of figures
    lom,  % list  of theorems
    log,  % list  of glossary
    loa,  % list  of algorithm
    lol,  % list  of listings
  }
\prop_set_from_keyval:Nn \c_ztoc_table_types_prop
  {
    sect       = toc,
    figure     = lof,
    table      = lot,
    theorem    = lom,
    algorithm  = loa,
    glossary   = log,
    lstlisting = lol,
  }
% leagcy sec class prop
\prop_const_from_keyval:Nn \c_zsect_level_leagcy_prop
  {
    volume        = -3,
    book          = -2,
    part          = -1,
    chapter       = 0,
    section       = 1,
    subsection    = 2,
    subsubsection = 3,
    paragraph     = 4,
    subparagraph  = 5,
  }
% --> section class path map (for future use)
% TODO: generate these path Dynamically
\prop_const_from_keyval:Nn \g__ztoc_class_pathmap_prop
  {
    subparagraph  = part/chapter/section/subsection/subsubsection/paragraph/,
    paragraph     = part/chapter/section/subsection/subsubsection/,
    subsubsection = part/chapter/section/subsection/,
    subsection    = part/chapter/section/,
    section       = part/chapter/,
    chapter       = part/,
  }


% ==> users' custom class level interface
% TODO: user may modify this constant variable,
%       is there a better way ?
\cs_new_protected:Npn \zsect_class_level_remap:n #1
  {
    % title class data: clist/tl/int
    % NOTE: this catch of 'empty prop' exception should come
    %       before prop assignment.
    \keyval_parse:NNn
      \__zsect_level_prop_empty_handle:n
      \zsect_config_sync:nn
      { #1 }
    % title class level prop
    \prop_gput_from_keyval:Nn \c_zsect_level_prop
      { #1 }
  }
\cs_new_protected:Npn \zsect_config_sync:nn #1#2
  { 
    % sync const
    \clist_if_in:NnF \c_zsect_level_clist 
      { #1 }
      { \int_gincr:N \g_zsect_level_int } 
    \clist_gput_right:Nn \c_zsect_level_clist 
      { {#1} }
    \tl_gput_right:Nn \c_zsect_level_tl 
      { {#1} }
    % sync mark class
    \__zsect_mark_user_sync:n { #1 }
    % sync cmds like '\l@section'
    \ztoc_lcmd_setup:nn { #1 }{ #2 }
    \clist_if_in:NnT \c_ztoc_special_level_clist { #1 }
      {
        \ztoc_special_lcmd_setup:nn { #1 }{ #2 }
      }
    % sync toc group parser variables
    \__ztoc_gparser_var_setup:n { #1 }
    % sync toc filter int
    \int_if_exist:cF { g__toc_filter_#1_int }
      {
        \int_new:c { g__toc_filter_#1_int }
      }
    % sync special toc class prop
    \clist_if_in:NnT \c_ztoc_special_level_clist { #1 }
      {
        \prop_gput_from_keyval:Nn \c_ztoc_special_level_prop
          { #1=#2 }
      }
  }
\cs_new:Npn \__zsect_level_prop_empty_handle:n #1
  {
    \ztex_msg_set:nn {zsect@levelprop@empty}
      { Level~re-mapping~invalid:~there~is~no~value~for~'#1'. }
    \ztex_msg_error:n {zsect@levelprop@empty}
  }
\cs_new:Npn \__zsect_mark_user_sync:n #1
  {
    \clist_gput_right:Nn \g__zsect_mark_user_clist
      { #1 }
    \zsect_mark_new_class_safe:nn 
      { \c_true_bool }
      { ztex-user-#1 }
  }
\NewDocumentCommand{\zseclevelmap}{m}
  {
    \zsect_class_level_remap:n {#1}
  }
\@onlypreamble\zseclevelmap



% ----------------------------------------------------------------------
%                           bookmark interface
% ----------------------------------------------------------------------
\cs_new_protected:Npn \zsect_bookmark_add:nnn #1#2#3
  {
    \pdfbookmark[#1]{#2}{#3}
  }
\cs_generate_variant:Nn \zsect_bookmark_add:nnn 
  { ene, eee }



% ----------------------------------------------------------------------
%                    toc interface variables init
%                      c / t / f / m / g / a / l
% ----------------------------------------------------------------------
% ==> table related variables setup
\seq_gclear_new:N \g__ztoc_table_enabled_seq
\clist_map_inline:Nn \c_ztoc_table_types_clist
  {
    %%% public:
    %   iow and iow checker:
    \iow_new:c  { g_ztoc_#1_iow }
    \bool_new:c { g_ztoc_#1_iow_bool }
    %   global table seq:
    \seq_gclear_new:c { g_ztoc_#1_seq }
    %   local table seq(relies on keyval seq):
    \seq_gclear_new:c { g_ztoc_local#1_seq }
    %   keyval table seq:
    \seq_gclear_new:c { g_ztoc_keyval#1_seq }

    %%% private:
    %   stopped keyval table seq:
    \seq_gclear_new:c { g__ztoc_stopped_keyval#1_seq }
  }


% ==> leagcy toc interface
% NOTE: 
% 1. redef these commands at last to prevent them from being modified;
% 2. '\numberline' has been deprecated in 'zsect'.
\ztex_hook_preamble_last:n
  {
    \cs_set_protected:Npn \numberline #1 
      { 
        \hb@xt@\zsect@dim@a{#1\hfil} 
      }
    % latex2e '\contentsline' syntax as follows: 
    %   \contentsline{<type>}{<entry>}{<page>}{<anchor>}
    % 'entry' looks like:
    %   \numberline {<toc name>}<toc title>
    \protected\def\contentsline #1#2#3#4
      {
        \gdef\@contentsline@destination 
          { #4 }
        \gdef\ztoc@current@class 
          { #1 } 
        \csname l@#1\endcsname {#2}{#3}
      }
  }
\cs_new_protected:Npn \zsect_leaders:nnnnn #1#2#3#4#5
  {% #1:type, #2:repeat, #3:width, #4:raise, #5:skip
    \cs:w #1leaders\cs_end: \hbox:n { 
      \box_move_up:nn { #4 }
        {
          \hbox_to_wd:nn {#3}{\hss #2 \hss}
        }
    } \hskip #5\relax
  }
\protected\def\@dottedtocline #1#2#3#4#5
  {%
    \ifnum #1>\c@tocdepth \else 
      \vskip \z@ \@plus.2\p@
      {\leftskip #2\relax \rightskip \@tocrmarg \parfillskip -\rightskip
        \parindent #2\relax\@afterindenttrue
        \interlinepenalty\@M
        \leavevmode
        \@tempdima #3\relax
        \advance\leftskip \@tempdima \null\nobreak\hskip -\leftskip
        {#4}\nobreak
        \leaders\hbox{$\m@th
          \mkern \@dotsep mu\hbox{.}\mkern \@dotsep
          mu$}\hfill
        \nobreak\hb@xt@\@pnumwidth{\hfil #5%
                                  \kern-\p@\kern\p@}%
        \par}%
    \fi
  }
% TODO: refactor '\zdottedtocline:nnnnnnnnn' to recieve more than
%       9 args using '\def\cmda#1{#1\cmdb} \def\cmdb#1{#1}'.
\cs_new_protected:Npn \zdottedtocline:nnnnnnnnn #1#2#3#4#5#6#7#8#9
  {% #3:('num' width) or (the extra rightskip for lines [2:-1]).
    \ifnum #1 > \c@tocdepth \else
      \vskip #9 \relax
      {
        \leftskip  #2 \relax
        \rightskip #3 \parfillskip -\rightskip
        \parindent #2 \relax\@afterindenttrue
        \interlinepenalty\@M
        \leavevmode
        \zsect@dim@a #4 \relax
        \advance\leftskip \zsect@dim@a 
        \null\nobreak \hskip -\leftskip
        { #5 } \nobreak
        #6 % leaders
        \nobreak #7 #8
      }
    \fi
  }
\cs_new_protected:Npn \dottedtocline:nnnnn #1#2#3#4#5
  {
    \zdottedtocline:nnnnnnnnn
      {#1}{#2}{\@tocrmarg}
      {#3}{#4}
      {
        \leaders\hbox
          {$ \m@th
            \mkern \@dotsep mu
            \hbox{.}
            \mkern \@dotsep mu
          $}\hfill
      }
      { \hb@xt@\@pnumwidth{\hfil\normalfont \normalcolor #5} }
      { \par }{ \z@ \@plus.2\p@ }
  }


% ==> ztoc tocline adding interface
\cs_new_protected:Npn \zsect_restore_protect: 
  { \let\protect\relax }
\cs_new_protected:Npn \zsect_unexpand_protect: 
  { \let\protect\noexpand }
\cs_new_protected:Npn \zsect_add_to_table:nn #1#2
  {% #1:table type; #2:content
    \bool_if:cT { g_ztoc_#1_iow_bool }
      {
        \zsect_unexpand_protect:
        \iow_now:ce { g_ztoc_#1_iow }
          { #2 }
        \zsect_restore_protect:
      }
  }
\cs_generate_variant:Nn \zsect_add_to_table:nn  
  { no, oo, ne, ee }

% >> normal toc
\cs_new_protected:Npn \zsect_add_toc_line:nnnn #1#2#3#4 
  {
    \bool_if:NT \g_ztoc_toc_iow_bool 
      {
        \zsect_unexpand_protect:
        \iow_now:Ne \g_ztoc_toc_iow
          {
            \token_to_str:N \contentsline{#1}{#2}{#3}{#4}
              \c_percent_str
          }
        \zsect_restore_protect:
      }
  }
\cs_generate_variant:Nn \zsect_add_toc_line:nnnn 
  { oooo, eeee, eeoe, nnee, nnoe }

% >> other contents(reley on '\caption' commands)
% NOTE:
% 1. theorem toc is handled in 'thm' module
% 2. if '\@captype' undefined, an ERROR will occur, 'figure'
%    and 'table' env define '\@captype' to 'figure' or 'table'.
% 3. package 'algorithm2e' redefine '\@caption' command 
%    inside env and restore it outside.
% TODO: replace hook with sockets for contents 
%       patch hook -- {zsect/caption/contents},
%       for that we only need one plug to recieve
%       toc args spec to generate table.
\hook_new_with_args:nn {zsect/caption/contents}{3}
% add contents hook to normal '\@caption':
\hook_gput_code_with_args:nnn
  { cmd/@caption/before }
  { zsect@caption@patches }
  {
    \hook_use:nnw {zsect/caption/contents}
      {3}{#1}{#2}{#1}
  }
% add contents hook to '\@caption' in 'algorithm2e':
\ztex_hook_preamble_last:n
  {
    \@ifpackageloaded{ algorithm2e }
      {
        \hook_gput_code_with_args:nnn
          { cmd/algocf@latexcaption/before }
          { zsect@algocaption@patches }
          {
            \hook_use:nnw {zsect/caption/contents}
              {3}{algorithm}{#2}{algocf}
          }
      }{ \relax }
  }
% add code to the above contents hooks:
\hook_gput_code_with_args:nnn
  { zsect/caption/contents }
  { zsect@caption@contents }
  {
    \use:c { zsect_add_#1_line:eeee } 
      { #1 }
      { {\use:c {the#3}}{\ignorespaces \exp_not:n {#2}} }
      { \thepage }
      { \ztexhyperTF {#1.\use:c {the#3}}{} }
  }
\cs_new_protected:Npn \zsect_add_table_line:nnnn #1#2#3#4 
  {
    \zsect_add_to_table:nn { lot }
      {
        \token_to_str:N \contentsline{#1}{#2}{#3}{#4}
          \c_percent_str
      }
  }
\cs_new_protected:Npn \zsect_add_figure_line:nnnn #1#2#3#4 
  {
    \zsect_add_to_table:nn { lof }
      {
        \token_to_str:N \contentsline{#1}{#2}{#3}{#4}
          \c_percent_str
      }
  }
\cs_new_protected:Npn \zsect_add_theorem_line:nnnn #1#2#3#4 
  {
    \zsect_add_to_table:nn { lom }
      {
        \token_to_str:N \contentsline{#1}{#2}{#3}{#4}
          \c_percent_str
      }
  }
\cs_new_protected:Npn \zsect_add_lstlisting_line:nnnn #1#2#3#4 
  {
    \zsect_add_to_table:nn { lol }
      {
        \token_to_str:N \contentsline{#1}{#2}{#3}{#4}
          \c_percent_str
      }
  }
\cs_new_protected:Npn \zsect_add_glossary_line:nnnn #1#2#3#4 
  {
    \zsect_add_to_table:nn { log }
      {
        \token_to_str:N \contentsline{#1}{#2}{#3}{#4}
          \c_percent_str
      }
  }
\cs_new_protected:Npn \zsect_add_algorithm_line:nnnn #1#2#3#4 
  {
    \zsect_add_to_table:nn { loa }
      {
        \token_to_str:N \contentsline{#1}{#2}{#3}{#4}
          \c_percent_str
      }
  }
\cs_generate_variant:Nn \zsect_add_table_line:nnnn  
  { oooo, eeee }
\cs_generate_variant:Nn \zsect_add_figure_line:nnnn 
  { oooo, eeee }
\cs_generate_variant:Nn \zsect_add_theorem_line:nnnn 
  { oooo, eeee }
\cs_generate_variant:Nn \zsect_add_lstlisting_line:nnnn 
  { oooo, eeee }
\cs_generate_variant:Nn \zsect_add_glossary_line:nnnn 
  { oooo, eeee }
\cs_generate_variant:Nn \zsect_add_algorithm_line:nnnn 
  { oooo, eeee }


% ==> float env for special class(use ltx interface)
% special '\caprion' to record contents
\cs_new_protected:Npn \zsect_caption_use:nnn #1#2#3
  {% #1:special class; #2:format; #3:caption
    \clist_if_in:NnTF \c_ztoc_special_level_clist
      { #1 }{ \def\@captype{#1} }
      {
        \ztex_msg_set:nn {wrong@caption@type}
          { caption~type~'#1'~is~not~permitted,~use~
          'figure',~'table',~etc~instead. }
        \ztex_msg_error:n {wrong@caption@type}
      }
    \__zsect_title_cnt_refstep:nn 
      { \g__ztex_hyperref_bool }
      { #1 }
    % caption format
    \cs_set:Npn \__zsect_caption_format:nn ##1##2
      { #2 }
    % sync contents
    \use:c { zsect_add_#1_line:eeee } 
      { #1 }
      {
        { \use:c {the#1} }
        {
          \tl_if_empty:nTF {#3}
            { \ignorespaces \exp_not:c {fnum@#1} }
            {
              \ignorespaces
              \exp_not:n {
                \__zsect_caption_format:nn 
                  { \use:c {fnum@#1} }
                  { #3 }
              }
            }
        }
      }
      { \thepage }
      { \ztexhyperTF {#1.\use:c {the#1}}{} }
    % typeset caption
    \__zsect_caption_format:nn 
      { \use:c {fnum@#1} }
      { #3 }
  }
\cs_generate_variant:Nn \zsect_caption_use:nnn
  { ooo, eee }
\NewDocumentCommand{\zsectcaption}
  {m O{##1\IfBlankF{##2}{:}##2} +m}
  {
    \zsect_caption_use:nnn
      { #1 }{ #2 }{ #3 }
  }

% ltx float env setup interface
\cs_new_protected:Npn \zsect_setup_ltx_float:nnnnnn #1#2#3#4#5#6
  {% #1:counter; #2:cnt form; #3:position; 
   % #4:level;   #5:ext;      #6:num.
    \cs_if_exist:cF { c@#1 }
      { \newcounter{#1} }
    \cs_set:cpn {the#1}{#2\use:c {c@#1}}
    \cs_set:cpn {fps@#1}{#3}
    \cs_set:cpn {ftype@#1}{#4}
    \cs_set:cpn {ext@#1}{#5}
    \cs_set:cpn {fnum@#1}{#6}
  }
\cs_new_protected:Npn \zsect_ltx_float_begin:n #1
  { \@float{#1} }
\cs_new_protected:Npn \zsect_ltx_float_end:
  { \end@float }


% ==> toc template declare
% NOTE: toc = name + title + leaders + page
\gdef\ztoc@leader@type{}
\gdef\ztoc@leader@content{.}
\long\gdef\ztoc@line@end{\par}
\def\ztoc@ignore@level{}

\newlength{\ztoc@rmargin}
\newlength{\ztoc@page@width}
\newlength{\ztoc@leader@sep}
\newlength{\ztoc@leader@raise}
\setlength{\ztoc@rmargin}{\@tocrmarg}
\setlength{\ztoc@leader@sep}{4.5pt}
\setlength{\ztoc@leader@raise}{0pt}
\setlength{\ztoc@page@width}{\@pnumwidth}

\NewTemplateType{ztextoc}{3}
\DeclareTemplateInterface{ztextoc}{default}{3}
  {
    no-parent     : boolean,

    ignore        : boolean    = { false },
    ignore.negate : boolean    = { false },
    ignore.text   : tokenlist  = \s__ztoc_ignore_empty_mark,
    ignore.name   : commalist  = { },
    ignore.page   : commalist  = { },

    hyper.name    : boolean    = { false },
    hyper.title   : boolean    = { false },
    hyper.page    : boolean    = { true },

    line.end      : tokenlist  = \ztoc@line@end,
    line.width    : length,

    name          : tokenlist  = { },
    name.width    : length,
    name.format   : tokenlist,
    name.format+  : tokenlist  = { },
    name.before   : tokenlist  = { },
    name.after    : tokenlist  = { },
    name.hyper    : boolean    = \KeyValue { hyper.name },

    title.width   : length,
    title.format  : tokenlist  = { },
    title.format+ : tokenlist  = { },
    title.before  : tokenlist  = { },
    title.after   : tokenlist  = { },
    title.hyper   : boolean    = \KeyValue { hyper.title },

    page.format   : tokenlist  = \normalfont\normalcolor,
    page.format+  : tokenlist  = { },
    page.before   : tokenlist  = { },
    page.after    : tokenlist  = { },
    page.width    : length     = \ztoc@page@width,
    page.hyper    : boolean    = \KeyValue { hyper.page },

    format        : tokenlist  = { },
    format+       : tokenlist  = { },
    format.name   : tokenlist  = \KeyValue { name.format },
    format.name+  : tokenlist  = \KeyValue { name.format+ },
    format.title  : tokenlist  = \KeyValue { title.format },
    format.title+ : tokenlist  = \KeyValue { title.format+ },
    format.page   : tokenlist  = \KeyValue { page.format },
    format.page+  : tokenlist  = \KeyValue { page.format+ },

    width.name     : length    = \KeyValue { name.width },
    width.title    : length,
    width.page     : length    = \KeyValue { page.width },
    width.line     : length    = \KeyValue { line.width },

    space.before   : skip,
    space.left     : skip,
    space.right    : skip      = \ztoc@rmargin,
    space.hang     : length    = \KeyValue { name.width },

    leader.fill    : skip      = { \fill },
    leader.sep     : length    = \ztoc@leader@sep,
    leader.raise   : length    = \ztoc@leader@raise,
    leader.type    : tokenlist = \ztoc@leader@type,
    leader.content : tokenlist = \ztoc@leader@content,

    explicit       : boolean   = { false },
    code           : tokenlist = { },
  }
\DeclareTemplateCode{ztextoc}{default}{3}
  {
    no-parent      = \l__ztoc_no_parent_bool,  % TODO: handle it in local toc

    ignore         = \l__ztoc_ignore_bool,
    ignore.text    = \l__ztoc_ignore_text_tl,
    ignore.name    = \l__ztoc_ignore_name_clist,
    ignore.page    = \l__ztoc_ignore_page_clist,
    ignore.negate  = \l__ztoc_ignore_negate_bool,

    line.end       = \l__ztoc_line_end_tl,
    line.width     = \l__ztoc_width_line_dim,  % TODO: handle this key in the future

    hyper.name     = \l__ztoc_hyper_name_bool,
    hyper.title    = \l__ztoc_hyper_title_bool,
    hyper.page     = \l__ztoc_hyper_page_bool,

    format         = \l__ztoc_format_tl,
    format+        = \l__ztoc_format_p_tl,
    format.name    = \l__ztoc_name_format_tl,
    format.name+   = \l__ztoc_name_format_p_tl,
    format.title   = \l__ztoc_title_format_tl,
    format.title+  = \l__ztoc_title_format_p_tl,
    format.page    = \l__ztoc_page_format_tl,
    format.page+   = \l__ztoc_page_format_p_tl,

    name           = \l__ztoc_name_tl,
    name.width     = \l__ztoc_width_name_dim,
    name.format    = \l__ztoc_name_format_tl,
    name.format+   = \l__ztoc_name_format_p_tl,
    name.before    = \l__ztoc_name_before_tl,
    name.after     = \l__ztoc_name_after_tl,
    name.hyper     = \l__ztoc_hyper_name_bool,

    title.width    = \l__ztoc_width_title_dim, 
    title.format   = \l__ztoc_title_format_tl,
    title.format+  = \l__ztoc_title_format_p_tl,
    title.before   = \l__ztoc_title_before_tl,
    title.after    = \l__ztoc_title_after_tl,
    title.hyper    = \l__ztoc_hyper_title_bool,

    page.format    = \l__ztoc_page_format_tl,
    page.format+   = \l__ztoc_page_format_p_tl,
    page.before    = \l__ztoc_page_before_tl,
    page.after     = \l__ztoc_page_after_tl,
    page.width     = \l__ztoc_width_page_dim,
    page.hyper     = \l__ztoc_hyper_page_bool,

    width.name     = \l__ztoc_width_name_dim,
    width.title    = \l__ztoc_width_title_dim, % TODO: handle this key in the future
    width.page     = \l__ztoc_width_page_dim,
    width.line     = \l__ztoc_width_line_dim,  % TODO: handle this key in the future

    space.before   = \l__ztoc_space_before_skip,
    space.left     = \l__ztoc_space_left_skip,
    space.right    = \l__ztoc_space_right_skip,
    space.hang     = \l__ztoc_space_hang_dim,

    leader.fill    = \l__ztoc_leader_fill_skip,
    leader.sep     = \l__ztoc_leader_sep_dim,
    leader.raise   = \l__ztoc_leader_raise_dim,
    leader.type    = \l__ztoc_leader_sep_tl,
    leader.content = \l__ztoc_leader_content_tl,

    explicit       = \l__ztoc_explicit_bool,
    code           = \l__ztoc_code_tl,
  }{
    %%% #1:toc depth(int); #2:{name}{title}; #3:page
    %%% NOTE: use '\ztoc@current@class' to get current class.
    \exp_args:No \__ztoc_step_toc_group_int:n 
      { \ztoc@current@class }
    \ztoc_get_class_level:No \ztoc@newclass@level 
      { \ztoc@current@class }
    \bool_while_do:nn
      {
        ( ! \seq_if_empty_p:N \g__ztoc_gparser_curstack_seq) &&
        ( 
          \int_compare_p:n 
            { 
              (
                \ztoc_get_class_level_expandable:e
                  {
                    \clist_item:en 
                      { \seq_item:Nn \g__ztoc_gparser_curstack_seq {1} }
                      { 1 }
                  } + 0
              )
              >= \ztoc@newclass@level 
            }
        )
      }{
        \seq_gpop:NN \g__ztoc_gparser_curstack_seq \l__ztoc_gparser_prev_tl
        \ztoc_group_hook_add:n {\l__ztoc_gparser_prev_tl,end}
        \ztoc_group_hook_add:n {\l__ztoc_gparser_prev_tl,after}
      }
    \ztoc_group_hook_add:n
      {
        \ztoc@current@class,
        \__ztoc_use_toc_group_int:e {\ztoc@current@class},
        before
      }
    \group_begin:
      \AssignTemplateKeys
      \__ztoc_dotted_tocline:nnn {#1}{#2}{#3}
    \group_end:
    \ztoc_group_hook_add:n
      {
        \ztoc@current@class,
        \__ztoc_use_toc_group_int:e {\ztoc@current@class},
        begin
      }
    \seq_gpush:Ne \g__ztoc_gparser_curstack_seq 
      {
        \ztoc@current@class
        ,\int_eval:n { \__ztoc_use_toc_group_int:e {\ztoc@current@class} }
      }
  }


% ==> add hooks to tocline
% toc group hook parser implement
\seq_new:N \g__ztoc_gparser_curstack_seq
\seq_gclear:N \g__ztoc_gparser_curstack_seq
\tl_new:N \l__ztoc_gparser_prev_tl
\tl_new:N \g__ztoc_gparser_begin_hook_tl
\seq_new:N \g__ztoc_group_hooks_seq
\seq_gclear:N \g__ztoc_group_hooks_seq
\bool_new:N \l_ztoc_show_hooks_bool
\bool_set_false:N \l_ztoc_show_hooks_bool
\cs_new_protected:Npn \ztoc_group_hook_add:n #1 
  {% #1:clist; #2:bool(true to insert end hook manually)
    \str_case:enF { \clist_item:en {#1}{-1} }
      {
        { before }{
            \__ztoc_group_hook_safe_new:ne
              { \c_true_bool }{ #1 }
            \exp_args:Ne \hook_use:n {#1} 
          }
        { begin }{
            \__ztoc_group_hook_safe_new:ne
              { \c_true_bool }{ #1 }
            \exp_args:Ne \hook_use:n {#1}
          }
        { end }{
            \__ztoc_group_hook_safe_new:ne
              { \c_false_bool }{ #1 }
            \exp_args:Ne \hook_use:n {#1}
          }
        { after }{
            \__ztoc_group_hook_safe_new:ne
              { \c_false_bool }{ #1 }
            \exp_args:Ne \hook_use:n {#1}
          }
      }{ \relax }
    \bool_if:NT \l_ztoc_show_hooks_bool
      { \rlap{\(\langle \texttt{#1} \rangle\)}\par }
  }
\cs_new:Npn \__ztoc_group_hook_safe_new:nn #1#2
  {
    \seq_if_in:NnF \g__ztoc_group_hooks_seq { #2 }
      {
        \bool_if:nTF { #1 }
          { \hook_new:n { #2 } }
          { \hook_new_reversed:n { #2 } }
        \seq_gput_right:Ne \g__ztoc_group_hooks_seq {#2}
      }
  }
\cs_generate_variant:Nn \__ztoc_group_hook_safe_new:nn 
  { ne }

% group hook aux functions:
\cs_new:Npn \__ztoc_gparser_var_setup:n #1
  {
    \bool_if_exist:cF { g__toc_#1_in_bool }
      { \bool_new:c { g__toc_#1_in_bool } } 
    \bool_gset_false:c { g__toc_#1_in_bool }
    \int_if_exist:cF { g__toc_group_#1_int }
      { \int_new:c { g__toc_group_#1_int } }
    \int_set:cn { g__toc_group_#1_int }{ 0 }
  }
\exp_args:Ne \clist_map_inline:nn 
  { \c_zsect_level_clist, \c_ztoc_special_level_clist }
  {
    \__ztoc_gparser_var_setup:n { #1 }
  }
\cs_new:Npn \__ztoc_reset_toc_group_int:
  {
    \clist_map_inline:Nn \c_zsect_level_clist
      {
        \int_gset:cn { g__toc_group_##1_int }
          { 0 }
      }
  }
\cs_new:Npn \__ztoc_step_toc_group_int:n #1 
  {
    \int_gincr:c { g__toc_group_#1_int }
    \__ztoc_reset_class_below_int:nn { #1 }{0}
  }
\cs_new:Npn \__ztoc_use_toc_group_int:n #1 
  {
    \int_use:c { g__toc_group_#1_int }
  }
\cs_generate_variant:Nn \__ztoc_use_toc_group_int:n { e }
\cs_new:Npn \__ztoc_reset_class_below_int:nn #1#2 
  {
    \ztoc_get_class_level:Nn \ztoc@tmplevel@int 
      { #1 }
    \prop_map_inline:Nn \c_zsect_level_prop
      {
        \int_compare:nNnT { ##2 } > { \ztoc@tmplevel@int }
          { 
            \int_gset:cn { g__toc_group_##1_int }{ #2 }
          }
      }
  }


% ==> toc ignore interface setup
\cs_set:Npn \__ztoc_dotted_tocline:nnn #1#2#3
  {
    \bool_if:NTF \l__ztoc_ignore_negate_bool 
      {
        \__ztoc_ignore_negate_parser:nnn {#1}{#2}{#3}
      }{
        \__ztoc_ignore_parser:nnn {#1}{#2}{#3}
      }
  }
\cs_new:Npn \__ztoc_ignore_parser:nnn #1#2#3
  {
    \clist_if_in:NnF \ztoc@ignore@level { #1 } 
      {
        \bool_if:NF \l__ztoc_ignore_bool
          {
            % NOTE: '#3' can NOT be warpped in any command, for
            %       example, '#3' can not be '\hyperlink{page.3}{3}'.
            \clist_if_in:NnF \l__ztoc_ignore_page_clist { #3 }
              {
                % NOTE: compare string instead of tokenlist, for that
                %      'title/name' may be formatted as '\textbf{xxx}'.
                \clist_if_empty:NTF \l__ztoc_ignore_name_clist
                  {
                    \exp_args:NNo \str_set:Nn \l_tmpb_str {\use_ii:nn #2}
                    \exp_args:NNo \str_if_in:NnF \l_tmpb_str
                      { \l__ztoc_ignore_text_tl }
                      {
                        \__ztoc_dotted_tocline_raw:nnn {#1}{#2}{#3}
                      }
                  }{
                    \clist_map_inline:Nn \l__ztoc_ignore_name_clist
                      {
                        \exp_args:NNo \str_set:Nn \l_tmpa_str {\use_i:nn #2}
                        \exp_args:NNo \str_set:Nn \l_tmpb_str {\use_ii:nn #2}
                        \str_if_in:NnF \l_tmpa_str { ##1 }           % check 'name'
                          {
                            \exp_args:NNo \str_if_in:NnF \l_tmpb_str % check 'title'('text')
                              { \l__ztoc_ignore_text_tl }
                              {
                                \__ztoc_dotted_tocline_raw:nnn {#1}{#2}{#3}
                              }
                          }
                      }
                  }
              }
          }
      }
  }
\cs_new:Npn \__ztoc_ignore_negate_parser:nnn #1#2#3
  {
    \clist_if_in:NnT \ztoc@ignore@level { #1 }
      {
        \__ztoc_dotted_tocline_raw:nnn {#1}{#2}{#3}
        \prg_map_break:Nn \__ztoc_ignore_negate_break: {}
      }
    \clist_if_in:NnT \l__ztoc_ignore_page_clist { #3 }
      {
        \__ztoc_dotted_tocline_raw:nnn {#1}{#2}{#3}
        \prg_map_break:Nn \__ztoc_ignore_negate_break: {}
      }
    \exp_args:NNo \str_set:Nn \l_tmpa_str {\use_i:nn #2}
    \clist_map_inline:Nn \l__ztoc_ignore_name_clist
      {
        \str_if_in:NnT \l_tmpa_str { ##1 }
          {
            \__ztoc_dotted_tocline_raw:nnn {#1}{#2}{#3}
            \prg_map_break:Nn \__ztoc_ignore_negate_break: {}
          }
      }
    %% name ignore parser begin ->
    \exp_args:NNo \str_set:Nn \l_tmpb_str {\use_ii:nn #2}
    \exp_args:NNo \str_if_in:NnT \l_tmpb_str
      { \l__ztoc_ignore_text_tl }
      {
        \__ztoc_dotted_tocline_raw:nnn {#1}{#2}{#3}
      }
    %% <- name ignore parser end
    \prg_break_point:Nn \__ztoc_ignore_negate_break: {}
  }

% NOTE: The implementation of '\__ztoc_dotted_tocline_raw:nnn' 
%       comes afterward.
\cs_new:Npn \__ztoc_ignore_negate_break:
  { \prg_map_break:Nn \__ztoc_ignore_negate_break: { } }


% ==> commands to get class level, including types:
%     Type 1: 'chapter', 'section' etc
%     Type 2: 'figure',  'table' etc (current private)
% NOTE: anytime when 'special toc class' maybe included,
%       replace '\prop_item:Nn \c_zsect_level_prop {#1}' 
%       by '\ztoc_get_class_level_expandable:n {#1}'
\cs_new:Npn \ztoc_get_class_level_expandable:n #1
  {
    \prop_if_in:NnT \c_zsect_level_prop { #1 }
      {
        \prop_item:Nn \c_zsect_level_prop {#1}
      }
    \prop_if_in:NnT \c_ztoc_special_level_prop { #1 }
      {
        \prop_item:Nn \c_ztoc_special_level_prop {#1}
      }
  }
\cs_new_protected:Npn \ztoc_get_class_level:Nn #1#2
  {
    \prop_if_in:NnT \c_zsect_level_prop { #2 }
      {
        \edef #1 
          { \prop_item:Nn \c_zsect_level_prop {#2} }
      }
    \prop_if_in:NnT \c_ztoc_special_level_prop { #2 }
      {
        \edef #1 
          { \prop_item:Nn \c_ztoc_special_level_prop {#2} }
      }
    \bool_lazy_any:nT
      {
        { !(\cs_if_exist_p:N #1) }
        { \tl_if_empty_p:N #1 }
      }{ 
        \ztex_msg_set:nn {ztoc@invalid@class}
          {
            \tl_if_empty:nTF {#2} 
              { current~toc~class~is~empty. }
              { '#2'~is~an~invalid~toc~class~for~ztex. }
          }
        \ztex_msg_error:n {ztoc@invalid@class} 
      }
  }
\cs_generate_variant:Nn \ztoc_get_class_level:Nn 
  { No, Ne }
\cs_generate_variant:Nn \ztoc_get_class_level_expandable:n 
  { o,  e }


% --->    inner components of toc below    <----
\hook_new_pair:nn
  { ztoc/tocline/begin }
  { ztoc/tocline/end }
\cs_new:Npn \__ztoc_dotted_tocline_raw:nnn #1#2#3
  {
    \ifnum #1 > \c@tocdepth \else
      \edef\ztoc@tmpa@skip
        {
          \skip_eval:n {
            \l__ztoc_space_left_skip -
            \l__ztoc_space_hang_dim
          }
        }
      \hook_use:n { ztoc/tocline/begin }
      \bool_if:NTF \l__ztoc_explicit_bool
        {
          \cs_set:Npn \ztocdepth { #1 }
          \cs_set:Npn \ztocpage  { #3 }
          \cs_set:Npn \ztocname
            { \__ztoc_extract_name:w #2\scan_stop: }
          \cs_set:Npn \ztoctitle
            { \__ztoc_extract_title:w #2\scan_stop: }
          \l__ztoc_code_tl
        }{
          {
            \vskip \l__ztoc_space_before_skip \relax
            \leftskip  \ztoc@tmpa@skip \relax
            \skip_if_finite:nF { \l__ztoc_leader_fill_skip }
              {
                \rightskip \l__ztoc_space_right_skip \parfillskip -\rightskip
              }
            \parindent \ztoc@tmpa@skip \relax\@afterindenttrue
            \interlinepenalty\@M
            \leavevmode
            \zsect@dim@a \l__ztoc_space_hang_dim \relax
            \advance\leftskip \zsect@dim@a 
            \null\nobreak \hskip -\leftskip
            { \__ztoc_name_title_typeset:nn {#2}{\@contentsline@destination} } \nobreak
            \__ztoc_dottedline_leader_set: \nobreak % leaders
            \__ztoc_dottedline_page_set:nn { #3 }{page.#3}
            \l__ztoc_line_end_tl
          }
      }
      \hook_use:n { ztoc/tocline/end }
      \skip_set:Nn \l__ztoc_space_before_skip {\z@ \@plus.2\p@}
    \fi
  }
% toc line internal items
\cs_new:Npn \__ztoc_name_title_typeset:nn #1#2
  {
    \__ztoc_item_hyper_begin_aux:nn {name}{ #2 }
    \exp_args:Nf \__ztoc_dottedline_name_set:n 
      { \__ztoc_extract_name:w #1\scan_stop: }
    \__ztoc_item_hyper_end_aux:n {name}
    \__ztoc_item_hyper_begin_aux:nn {title}{ #2 }
    \exp_args:Nf \__ztoc_dottedline_title_set:n 
      { \__ztoc_extract_title:w #1\scan_stop: }
    \__ztoc_item_hyper_end_aux:n {title}
  }
\cs_new:Npn \__ztoc_item_hyper_begin_aux:nn #1#2
  { 
    \bool_if:cT { l__ztoc_hyper_#1_bool }
      {
        \hyper@linkstart{link}{#2} 
      }
  }
\cs_new:Npn \__ztoc_item_hyper_end_aux:n #1
  { 
    \bool_if:cT { l__ztoc_hyper_#1_bool }
      { \hyper@linkend }
  }
\cs_new:Npn \__ztoc_dottedline_name_set:n #1 
  {
    \hbox_set:Nn \l__ztoc_name_box 
      {
        \l__ztoc_format_tl
        \l__ztoc_format_p_tl
        \l__ztoc_name_format_tl
        \l__ztoc_name_format_p_tl
        \l__ztoc_name_before_tl
        \tl_if_empty:NTF \l__ztoc_name_tl 
          { #1 }{ \l__ztoc_name_tl }
        \l__ztoc_name_after_tl
      }
    \dim_compare:nTF { \l__ztoc_width_name_dim = 0pt }
      {
        \box_use_drop:N \l__ztoc_name_box
      }{
        \hb@xt@ \l__ztoc_width_name_dim
          { \box_use_drop:N \l__ztoc_name_box \hss }
      }
  }
\cs_new:Npn \__ztoc_dottedline_title_set:n #1 
  {
    % \hb@xt@ \l__ztoc_width_title_dim 
      {
        \l__ztoc_format_tl
        \l__ztoc_format_p_tl
        \l__ztoc_title_format_tl
        \l__ztoc_title_format_p_tl
        \l__ztoc_title_before_tl
        #1
        \l__ztoc_title_after_tl
      }
  }
\cs_new:Npn \__ztoc_dottedline_leader_set: 
  {
    \zsect_leaders:nnnnn { \l__ztoc_leader_sep_tl }
      { \l__ztoc_leader_content_tl }
      { \dim_eval:n {\l__ztoc_leader_sep_dim*2} }
      { \l__ztoc_leader_raise_dim }
      { \l__ztoc_leader_fill_skip }
  }
\cs_new:Npn \__ztoc_dottedline_page_set:nn #1#2
  {
    \__ztoc_item_hyper_begin_aux:nn {page}{ #2 }
    \hb@xt@\l__ztoc_width_page_dim
      {
        \hss
        \l__ztoc_page_format_tl
        \l__ztoc_page_format_p_tl 
        \l__ztoc_page_before_tl
        \l__ztoc_format_tl
        \l__ztoc_format_p_tl
        #1
        \l__ztoc_page_after_tl
      }
    \__ztoc_item_hyper_end_aux:n {page}
  }
\cs_new:Npn \__ztoc_extract_name:w #1\scan_stop:
  { \tl_item:nn {#1}{1} }
\cs_new:Npn \__ztoc_extract_title:w #1\scan_stop:
  { \tl_item:nn {#1}{-1} }
% --->    inner components of toc above    <----


% ==> declare '\l@<class>' in an abstract level
\DeclareInstance{ztextoc}{ztoc/level 1}{default}
  {
    format         = \large\bfseries,
    name.width     = 1.9em,
    space.before   = 1em\@plus\p@,
    space.hang     = 1.9em,
    space.left     = 1.9em,
    leader.content = ,
  }
\DeclareInstance{ztextoc}{ztoc/level 2}{default}
  {
    format         = \bfseries,
    name.width     = 1.5em,
    space.before   = 1em\@plus\p@,
    space.hang     = 1.5em,
    space.left     = 1.5em,
    leader.content = ,
  }
\DeclareInstance{ztextoc}{ztoc/level 3}{default}
  {
    name.width     = 2.3em,
    space.hang     = 2.3em,
    space.left     = 3.8em,
  }
\DeclareInstance{ztextoc}{ztoc/level 4}{default}
  {
    name.width     = 3.2em,
    space.hang     = 3.2em,
    space.left     = 7em,
  }
\DeclareInstance{ztextoc}{ztoc/level 5}{default}
  {
    name.width     = 4.1em,
    space.hang     = 4.1em,
    space.left     = 11.1em,
  }
\DeclareInstance{ztextoc}{ztoc/level 6}{default}
  {
    name.width     = 5em,
    space.hang     = 5em,
    space.left     = 16.2em,
  }
\DeclareInstance{ztextoc}{ztoc/level 7}{default}
  {
    name.width     = 6em,
    space.hang     = 6em,
    space.left     = 22.25em,
  }


% ==> setup '\l@<class>' command in toc.
% NOTE: for that packages like 'listings' maybe redefine
%       '\l@<class>', we define them at preamble last.
\cs_new_protected:Npn \ztoc_lcmd_setup:nn #1#2
  {% #1:class; #2:level(int)
    \ztex_label_hook_preamble_last:nn
      { ztex/sect/lcmd }
      {
        \cs_set:cpn {l@#1} ##1##2
          {
            \UseInstance{ ztextoc }
              { ztoc/level #2 }
              { #2 }{ ##1 }{ ##2 }
          }
      }
  }
\cs_new_protected:Npn \ztoc_special_lcmd_setup:nn #1#2
  {% #1:class; #2:level(int)
    \DeclareInstanceCopy{ztextoc}
      { ztoc/#1 }{ ztoc/level #2 }
    \ztex_label_hook_preamble_last:nn
      { ztex/sect/lcmd@special }
      {
        \cs_set:cpn {l@#1} ##1##2
          {
            \UseInstance{ ztextoc }
              { ztoc/#1 }
              { #2 }{ ##1 }{ ##2 }
          }
      }
  }
\cs_generate_variant:Nn \ztoc_lcmd_setup:nn 
  { oo, ee }
\cs_generate_variant:Nn \ztoc_special_lcmd_setup:nn 
  { oo, ee }
\prop_map_inline:Nn \c_zsect_level_prop 
  {
    \ztoc_lcmd_setup:nn 
      { #1 }{ #2 }
  }
\clist_map_inline:Nn \c_ztoc_special_level_clist
  {
    \exp_args:Nne \ztoc_special_lcmd_setup:nn { #1 }
      { 
        \prop_item:Nn \c_ztoc_special_level_prop 
          { #1 }
      }
  }


% ==> 'toc line add' for 'sec' part
\cs_new_protected:Npn \__zsect_title_toc_add:nnn #1#2#3 
  {
    \zsect_unexpand_protect:
    \exp_args:Ne \int_compare:nT
      { \c@tocdepth >= \prop_item:Nn \c_zsect_level_prop {#1} }
      {
        \zsect_add_toc_line:nnnn
          { #1 }
          { 
            { \zsect@tocnum }
            {
              % NOTE: to support command '\texorpdfstring' in '#2', the
              %       original '\exp_not:n {#2}' has been removed, you
              %       need to add macro '\protect' manually !
              \exp_args:Nne \tl_if_empty:nTF { #2 }
                { #3 }{ #2 }
            }
          }
          { \thepage }
          { \ztexhyperTF {#1.\zsect@tocnum}{} }
      }
    \zsect_restore_protect:
  }


% ==> user interface for 'toc' part:
%% programming layer
% >> group hooks add
\cs_new_protected:Npn \ztoc_group_hook_create:Nnnn #1#2#3#4
  {
    \exp_args:No \__ztoc_step_toc_group_int:n 
      { \ztoc@current@class }
    \ztoc_get_class_level:No \ztoc@newclass@level 
      { \ztoc@current@class }
    \bool_while_do:nn
      {
        ( ! \seq_if_empty_p:N \g__ztoc_gparser_curstack_seq) &&
        ( 
          \int_compare_p:n 
            { 
              (
                \ztoc_get_class_level_expandable:e
                  {
                    \clist_item:en 
                      { \seq_item:Nn \g__ztoc_gparser_curstack_seq {1} }
                      { 1 }
                  } + 0
              )
              >= \ztoc@newclass@level 
            }
        )
      }{
        \seq_gpop:NN \g__ztoc_gparser_curstack_seq \l__ztoc_gparser_prev_tl
        \ztoc_group_hook_add:n {\l__ztoc_gparser_prev_tl,end}
        \ztoc_group_hook_add:n {\l__ztoc_gparser_prev_tl,after}
      }
    \ztoc_group_hook_add:n
      {
        \ztoc@current@class,
        \__ztoc_use_toc_group_int:e {\ztoc@current@class},
        before
      }
    #1 {#2}{#3}{#4}
    \ztoc_group_hook_add:n
      {
        \ztoc@current@class,
        \__ztoc_use_toc_group_int:e {\ztoc@current@class},
        begin
      }
    \seq_gpush:Ne \g__ztoc_gparser_curstack_seq 
      {
        \ztoc@current@class
        ,\int_eval:n { \__ztoc_use_toc_group_int:e {\ztoc@current@class} }
      }
  }
\cs_generate_variant:Nn \ztoc_group_hook_create:Nnnn { c }
% >> control table iow
\cs_new_protected:Npn \ztoc_stop_table:n #1
  {
    % stop iow of table
    \bool_gset_false:c { g_ztoc_#1_iow_bool }
    % dump keyval seq to file (after the seq2file in '\tocenable')
    \seq_gset_eq:cc { g__ztoc_stopped_keyval#1_seq }
      { g_ztoc_keyval#1_seq }
    \bool_if:NT \g__zsect_dump_ptable_bool
      {
        \ztex_hook_doc_end:n
          {
            \ztool_write_seq_to_file:nce { \c_true_bool } 
              { g__ztoc_stopped_keyval#1_seq }
              { \c_sys_jobname_str.p#1 }
          }
      }
  }
% >> table typeset (include toc group hooks)
\cs_new_protected:Npn \ztoc_save_main_table:n #1
  {
    % NOTE: read '\jobname.toc' in the second time, you
    %       will get nothing, i.e. variable '\g_ztoc_toc_seq'
    %       will be set to empty.
    \str_if_eq:eeF { #1 }{ \c_sys_jobname_str }
      {
        \ztoc_localtable_seq_save:n { toc }
        \ztoc_generate_table_seq:nn { #1 }{ toc }
      }
  }
\cs_new_protected:Npn \ztoc_restore_main_table:n #1
  {
    \str_if_eq:eeF { #1 }{ \c_sys_jobname_str }
      {
        \ztoc_localtable_seq_restore:n { toc }
      }
  }
% table typeset before/after
\cs_new_protected:Npn \ztoc_table_typeset_before:
  {
    \__ztoc_reset_toc_group_int:
  }
\cs_new_protected:Npn \ztoc_table_typeset_after:
  {
    \seq_map_inline:Nn \g__ztoc_gparser_curstack_seq
      {
        \seq_gpop:NN 
          \g__ztoc_gparser_curstack_seq 
          \l__ztoc_gparser_prev_tl
        \ztoc_group_hook_add:n 
          { \l__ztoc_gparser_prev_tl,end }
        \ztoc_group_hook_add:n 
          { \l__ztoc_gparser_prev_tl,after }
      }
  }
% NOTE: anytime you need to typeset a table, use the
%       following command, or the hooks may be wrong.
\cs_new_protected:Npn \ztoc_table_typeset:Nn #1#2
  {% #1:table seq; #2:separator.
    \ztoc_table_typeset_before:
      \seq_use:Nn #1 { #2 }
    \ztoc_table_typeset_after:
  }
\cs_generate_variant:Nn \ztoc_table_typeset:Nn 
  { Ne, cn, ce }

% >> toc format setup interface
\cs_new_protected:Npn \ztoc_normal_format_set:Nn #1#2
  {
    \token_if_cs:NF #1
      {
        \ztex_msg_set:nn {ztoc@format@notcs}
          { current~toc~class~argument:~'#1'~is~not~a~control~sequence. }
        \ztex_msg_error:n {ztoc@format@notcs}
      }
    \prop_if_in:NeF \c_zsect_level_prop { \cs_to_str:N #1 }
      {
        \ztex_msg_set:nn {ztoc@instancenormal@nonexist}
          {
            Instance~'ztoc/level\prop_item:Ne \c_zsect_level_prop {\cs_to_str:N #1}'~
            for~\tl_to_str:n {#1} of~type~'ztextoc'~do~NOT~exist. 
          }
        \ztex_msg_error:n {ztoc@instancenormal@nonexist}
      }
    \exp_args:Nne \EditInstance{ztextoc}
      { ztoc/level
        \prop_item:Ne \c_zsect_level_prop 
          { \cs_to_str:N #1 }
      }{ #2 }
  }
\cs_new_protected:Npn \ztoc_special_format_set:nn #1#2
  {
    \prop_if_in:NnF \c_ztoc_special_level_prop { #1 }
      {
        \ztex_msg_set:nn {ztoc@instancespecial@nonexist}
          { 
            Instance~'ztoc/#1'~for~'#1'~of
            ~type~'ztextoc'~do~NOT~exist. 
          }
        \ztex_msg_error:n {ztoc@instancespecial@nonexist}
      }
    \exp_args:Nne \EditInstance{ztextoc}
      { ztoc/#1 }{ #2 }
  }
\cs_new_protected:Npn \ztoc_all_format_set:nn #1#2
  {
    \clist_map_inline:nn { #1 }
      {
        \prop_if_in:NnTF \c_ztoc_special_level_prop { ##1 }
          {
            \ztoc_special_format_set:nn { ##1 }{ #2 }
            \prg_map_break:Nn \__ztoc_format_user_break: {}
          }{
            \ztoc_normal_format_set:Nn  { ##1 }{ #2 }
            \prg_map_break:Nn \__ztoc_format_user_break: {}
          }
        \prg_break_point:Nn \__ztoc_format_user_break: {}
      }
  }
\cs_new:Npn \__ztoc_format_user_break:
  { \prg_map_break:Nn \__ztoc_format_user_break: {} }

% >> table data setup interface
\cs_new_protected:Npn \ztoc_generate_table_seq:nn #1#2
  {% #1:file(no ext); #2:type(toc, lof, etc)
    % generate global toc seq
    \ztool_gread_file_as_seq:nnc { \c_false_bool }
      { #1.#2 }
      { g_ztoc_#2_seq }
    % generate keyval toc seq
    \ztoc_generate_keyvaltable_seq:nc { #1.#2 }
      { g_ztoc_keyval#2_seq }
  }
\cs_new_protected:Npn \ztoc_enable_table:nn #1#2
  {% #1:file; #2:toc, lom, etc.
    \clist_map_inline:nn { #2 }
      {
        % generate (keyval) toc seq
        \ztoc_generate_table_seq:nn { #1 }{ ##1 }
        % dump '*.ptoc, *.plot' for debugging
        \bool_if:NT \g__zsect_dump_ptable_bool
          {
            \str_if_eq:eeT { #1 }{ \c_sys_jobname_str }
              {
                \ztex_hook_doc_end:n
                  {
                    \ztool_write_seq_to_file:nce { \c_true_bool } 
                      { g_ztoc_keyval##1_seq   }
                      { \c_sys_jobname_str.p##1 }
                  }
              }
          }
        % stream for writing table file
        \str_if_eq:eeT { #1 }{ \c_sys_jobname_str }
          {
            \bool_gset_true:c { g_ztoc_##1_iow_bool }
            \exp_args:Nne \iow_open:cn { g_ztoc_##1_iow }
              { \c_sys_jobname_str.##1 }
          }
      }
  }
\cs_new:Npn \ztoc_enable_table_swap:nn #1#2
  { \ztoc_enable_table:nn { #2 }{ #1 } }

% >> save and restore table data seq
\seq_new:N \g__ztoc_localtable_tmp_seq
\seq_gclear:N \g__ztoc_localtable_tmp_seq
\seq_new:N \g__ztoc_localtable_keyvaltmp_seq
\seq_gclear:N \g__ztoc_localtable_keyvaltmp_seq
% NOTE: the 'save' function should before '\ztoc_generate_table_seq'
\cs_new_protected:Npn \ztoc_localtable_seq_save:n #1
  {
    \seq_gset_eq:Nc \g__ztoc_localtable_tmp_seq 
      { g_ztoc_#1_seq }
    \seq_gset_eq:Nc \g__ztoc_localtable_keyvaltmp_seq 
      { g_ztoc_keyval#1_seq }
  }
\cs_new_protected:Npn \ztoc_localtable_seq_restore:n #1
  {
    \seq_gset_eq:cN { g_ztoc_#1_seq }
      \g__ztoc_localtable_tmp_seq
    \seq_gset_eq:cN { g_ztoc_keyval#1_seq }
      \g__ztoc_localtable_keyvaltmp_seq
    \seq_gclear:N \g__ztoc_localtable_tmp_seq
    \seq_gclear:N \g__ztoc_localtable_keyvaltmp_seq
  }

% >> generate keyval toc seq variables, e.g., 
%    '\g_ztoc_keyval<toc|lof|...>_seq' from a 
%    user-specified toc, lof, ... file.
\seq_new:N \l__ztoc_keyvaltable_tmp_seq
\cs_new_protected:Npn \ztoc_generate_keyvaltable_seq:nN #1#2
  {% #1:file with ext; #2:seq
    \seq_gclear:N #2
    \ztool_gread_file_as_seq_keep_spaces:nnN 
      { \c_false_bool }{ #1 }
      \l__ztoc_keyvaltable_tmp_seq
    \seq_map_inline:Nn \l__ztoc_keyvaltable_tmp_seq
      {
        \__ztoc_keyval_table_parser:Nw
          #2 ##1 \scan_stop:
      }
  }
\cs_generate_variant:Nn \ztoc_generate_keyvaltable_seq:nN 
  { nc, oN, eN }
\cs_new:Npn \__ztoc_keyval_table_parser:Nw #1\contentsline #2#3#4#5\scan_stop:
  {
    \zsect_unexpand_protect:
    \edef\ztoc@keyvalparser@nametitle
      {
        \zcmd_exp_not_tl:n
          { #3 }
      }
    \seq_gput_right:Ne #1 
      {
        class = { \exp_not:n {#2} },
        name  = { \exp_after:wN \use_i:nn  \ztoc@keyvalparser@nametitle },
        title = { \exp_after:wN \use_ii:nn \ztoc@keyvalparser@nametitle },
        page  = { \exp_not:n {#4} },
        raw   = { \exp_not:N \contentsline
                    { \exp_not:n {#2} }
                    { \exp_not:n {#3} }
                    { \exp_not:n {#4} }
                    { \exp_not:n {#5} }
                }
      }
    \cs_undefine:N \ztoc@keyvalparser@nametitle
    \zsect_restore_protect:
  }

% >> extract toc in local region (relies on keyval toc seq)
\cs_new_protected:Npn \ztoc_table_filter_byclass:nnNN #1#2#3#4 
  {% #1:class; #2:index; #3:raw seq; #4:res seq
    \seq_gclear:N #4
    \bool_set_false:N \l__ztoc_filter_item_found_bool
    \seq_map_inline:Nn #3
      {
        \prop_set_from_keyval:Nn \l_tmpa_prop { ##1 }
        \exp_args:Ne \__ztoc_step_filter_int:n 
          { \prop_item:Nn \l_tmpa_prop {class} }
        \exp_args:Ne \int_compare:nNnT 
          { \__ztoc_use_filter_int:n {#1} } = {#2+1}
          { \seq_map_break: }
        \bool_if:NT \l__ztoc_filter_item_found_bool 
          {
            \exp_args:Ne \int_compare:nNnT
              { \prop_item:Nn \c_zsect_level_prop {#1} } 
              > 
              { \exp_args:NNe \prop_item:Nn \c_zsect_level_prop 
                  { \prop_item:Nn \l_tmpa_prop {class} } 
              }{ \seq_map_break: }
          }
        \exp_args:Ne \int_compare:nNnT 
          { \__ztoc_use_filter_int:n {#1} } = {#2}
          {
            \bool_set_true:N \l__ztoc_filter_item_found_bool
            \seq_gput_right:Ne #4
              { \prop_item:Nn \l_tmpa_prop {raw} }
          }
      }
    \__ztoc_reset_filter_int:
  }
\bool_new:N \l__ztoc_filter_item_found_bool
\exp_args:Ne \clist_map_inline:nn 
  { \c_zsect_level_clist, \c_ztoc_special_level_clist }
  {
    \int_new:c { g__toc_filter_#1_int }
  }
\cs_new:Npn \__ztoc_reset_filter_int: 
  {
    \exp_args:Ne \clist_map_inline:nn
      { \c_zsect_level_clist, \c_ztoc_special_level_clist }
      {
        \int_gset:cn { g__toc_filter_##1_int }
          { 0 }
      }
  }
\cs_new:Npn \__ztoc_step_filter_int:n #1 
  {
    \int_gincr:c { g__toc_filter_#1_int }
  }
\cs_new:Npn \__ztoc_use_filter_int:n #1 
  { 
    \int_use:c { g__toc_filter_#1_int }
  }
\cs_generate_variant:Nn \ztoc_table_filter_byclass:nnNN
  { ne, en, ee, nncc, eecc }

% >> new TemplateType from scratch
\cs_new_protected:Npn \ztoc_new_templatetype:nn #1#2
  { 
    \NewTemplateType{ztoc#1}{#2}
  }
\cs_new_protected:Npn \ztoc_declare_template_interface:nnnn #1#2#3#4
  {
    \DeclareTemplateInterface{ztoc#1}{#2}
      {#3}{#4}
  }
\cs_new_protected:Npn \ztoc_declare_template_code:nnnnn #1#2#3#4#5
  {
    \DeclareTemplateCode{ztoc#1}{#2}
      {#3}{#4}{#5}
  }


%% document layer
% >> template defaults & one-time toc
\NewDocumentCommand{\ztocTemplateDefaultsEdit}{m}
  {
    \EditTemplateDefaults{ztextoc}{default}
      { #1 }
  }
\cs_new_protected:Npn \ztoc_once_tocline:nnnn #1#2#3#4
  {
    \UseTemplate{ztextoc}{default}{ #1 }
      { #2 }{ #3 }{ #4 }
  }
\cs_generate_variant:Nn \ztoc_once_tocline:nnnn 
  { nooo, neee, oooo, eeee }
\NewDocumentCommand{\ztoclineOnce}{mmmm}
  {
    \gdef\ztoc@current@class { #2 }
    \exp_args:Nne \ztoc_once_tocline:nnnn
      { #1 } % keyval settings
      { \ztoc_get_class_level_expandable:n {#2} } % toc depth
      { #3 } % {name}{title}
      { #4 } % page
    \cs_undefine:N \ztoc@current@class
  }

% >> enable/disable table interface
\NewDocumentCommand{\ztocenable}{ O{toc} }
  {
    \seq_gset_from_clist:Nn \g__ztoc_table_enabled_seq 
      { #1 }
    \keyval_parse:nnn
      { \ztoc_enable_table:nn {\c_sys_jobname_str} }
      { \ztoc_enable_table_swap:nn }
      { #1 }
  }
\NewDocumentCommand{\ztocstop}{O{toc}}
  {
    \clist_map_inline:nn { #1 }
      {
        \ztoc_stop_table:n { ##1 }
      }
  }

% >> toc format setup
\ztex_keys_define:nn { ztoc/option }
  {
    rmargin        .code:n = { \setlength\ztoc@rmargin {#1} },
    ignore.level   .code:n = { \gdef\ztoc@ignore@level {#1} },

    line.end       .code:n = { \long\gdef\ztoc@line@end  {#1} },
    page.width     .code:n = { \setlength\ztoc@page@width{#1} }, 

    leader.type    .code:n = { \gdef\ztoc@leader@type{#1} },
    leader.sep     .code:n = { \setlength\ztoc@leader@sep  {#1} },
    leader.raise   .code:n = { \setlength\ztoc@leader@raise{#1} },
    leader.content .code:n = { \setlength\ztoc@leader@content{#1} },
  }
\NewDocumentCommand{\ztocset}{ m }
  {
    \ztex_keys_set:nn { ztoc/option }
      { #1 }
  }
\NewDocumentCommand{\ztocformat}{m+m}
  { 
    \ztoc_all_format_set:nn {#1}{#2}
  }
\NewDocumentCommand{\ztocgroupinsert}{m+m}
  {
    \hook_gput_next_code:nn {#1}{#2}
  }
\NewDocumentCommand{\ztocgroupshow}{}
  { \bool_set_true:N \l_ztoc_show_hooks_bool }
\NewDocumentCommand{\ztocgrouphide}{}
  { \bool_set_false:N \l_ztoc_show_hooks_bool }

% >> commands to print toc
% global toc interface
\DeclareDocumentCommand{\tableofcontents}{ O{\jobname} }
  {
    \ztoc_save_main_table:n { #1 }
      \ztoc_table_typeset:Nn \g_ztoc_toc_seq {}
    \ztoc_restore_main_table:n { #1 }
  }
\DeclareDocumentCommand{\multicolcontents}{ O{\jobname}m }
  {
    \ztoc_save_main_table:n { #1 }
      \begin{multicols}{#2}
        \ztoc_table_typeset:Nn \g_ztoc_toc_seq {}
      \end{multicols}
    \ztoc_restore_main_table:n { #1 }
  }
% local toc interface
\NewDocumentCommand{\zlocaltoc}{O{\jobname}mm}
  {
    \ztoc_save_main_table:n { #1 }
    \ztoc_table_typeset_before:
      \edef\zlocaltoc@curext
        { 
          \exp_args:NNe \prop_item:Nn \c_ztoc_table_types_prop 
            { 
              \prop_if_in:NnTF \c_zsect_level_prop { #2 }
                { sect }{ #2 }
            }
        }
      \clist_map_inline:nn { #3 }
        {
          \ztoc_table_filter_byclass:nncc
            { #2 }{ ##1 }
            { g_ztoc_keyval\zlocaltoc@curext _seq }
            { g_ztoc_local \zlocaltoc@curext _seq }
          \seq_use:cn
            { g_ztoc_local\zlocaltoc@curext _seq } 
            {  }
          \ztoc_table_typeset_after:
        }
      \cs_undefine:N \zlocaltoc@curext
    \ztoc_restore_main_table:n { #1 }
  }



% ----------------------------------------------------------------------
%                      list of tables, figures, etc
% ----------------------------------------------------------------------
% >> special class contents format
\NewDocumentCommand{\ztocotherformat}{O{figure}m}
  {
    \prop_if_in:NnTF \c_ztoc_special_level_prop { #1 }
      {
        \exp_args:Nne \EditInstance{ztextoc}
          { ztoc/#1 }{#2}
      }{
        \ztex_msg_set:nn {ztoc@instancespecial@nonexist}
          { Instance~'ztoc/#1'~of~type~'ztextoc'~do~NOT~exist. }
        \ztex_msg_error:n {ztoc@instancespecial@nonexist}
      }
  }

% >> print contents
\DeclareDocumentCommand{\listoffigures}{}
  {
    \ztoc_table_typeset:Nn \g_ztoc_lof_seq 
      {}
  }
\DeclareDocumentCommand{\listoftables}{}
  {
    \ztoc_table_typeset:Nn \g_ztoc_lot_seq 
      {}
  }
\DeclareDocumentCommand{\listoftheorems}{}
  {
    \ztoc_table_typeset:Nn \g_ztoc_lom_seq 
      {}
  }
\DeclareDocumentCommand{\listoflistings}{}
  {
    \ztoc_table_typeset:Nn \g_ztoc_lol_seq 
      {}
  }
% NOTE: package 'algorithm2e' define '\listofalgorithms'.
\ztex_hook_preamble_last:n
  {
    \DeclareDocumentCommand{\listofalgorithms}{}
      {
        \ztoc_table_typeset:Nn \g_ztoc_loa_seq 
          {}
      }
  }
% NOTE: make this change to command name 
%       according to 'glossaries' package.
\DeclareDocumentCommand{\printglossaries}{}
  {
    \ztoc_table_typeset:Nn \g_ztoc_log_seq 
      {}
  }
\DeclareCommandCopy{\listofglossaries}
  {\printglossaries}



% ----------------------------------------------------------------------
%                           section title interface
% ----------------------------------------------------------------------
% ==> mark interface
\cs_new_protected:Npn \zsect_mark_new_class_safe:nn #1#2
  {% #1:bool; #2:class
    \seq_if_in:NnTF \g__mark_classes_seq { #2 }
      {
        \ztex_msg_set:nn { mark-override }
          { mark~class:'#2'~already~exists,~you~can~NOT~override~it }
        \ztex_msg_error:n { mark-override }
      }{
        \mark_new_class:n { #2 }
        \bool_if:nT { #1 }
          {
            \mark_new_class:n { #2-nonempty }
          }
      }
  }
\zsect_mark_new_class_safe:nn { \c_false_bool }{ ztex-1st   }
\zsect_mark_new_class_safe:nn { \c_false_bool }{ ztex-left  }
\zsect_mark_new_class_safe:nn { \c_true_bool  }{ ztex-right }
\zsect_mark_new_class_safe:nn { \c_false_bool }{ ztex-4th   }
\cs_new_protected:Npn \zsect_mark_insert:nn #1#2
  {
    \exp_args:Ne \int_case:nn { \prop_item:Nn \c_zsect_level_prop {#1} }
      {
        {1}{ \mark_insert:nn { ztex-1st } {#2} }
        {2}{ \mark_insert:nn { ztex-left} {#2} }
        {3}{ \zsect_right_mark_insert:n   {#2} }
        {4}{ \mark_insert:nn { ztex-4th } {#2} }
      }
    \clist_if_in:NnT \g__zsect_mark_user_clist {#1}
      {
        \zsect_mark_user_insert:nn { #1 }{ #2 }
      }
  }
\cs_new_protected:Npn \zsect_mark_user_insert:nn #1#2
  {
    \mark_insert:nn {ztex-user-#1}{#2}
    \tl_if_empty:eF {#2}
      {
        \mark_insert:nn {ztex-user-#1-nonempty}{#2}
      }
  }
\cs_new_protected:Npn \zsect_right_mark_insert:n #1
  {
    \mark_insert:nn {ztex-right}{#1}
    \tl_if_empty:eF {#1}
      {
        \mark_insert:nn {ztex-right-nonempty}{#1}
      }
  }
\cs_new_protected:Npn \zsect_markclass_lower_empty:n #1 
  {
    \prop_map_inline:Nn \c_zsect_level_prop 
      {
        % NOTE:only have 4 mark class at now.
        \int_compare:nT { ##2 > 4 }
          { \prop_map_break: }
        \int_compare:nNnT { ##2 } >
          { \prop_item:Nn \c_zsect_level_prop {#1}  }
          { \zsect_mark_insert:nn {##1}{} }
      }
  }
\cs_generate_variant:Nn \zsect_mark_insert:nn 
  { Vn, ee }
\cs_generate_variant:Nn \zsect_markclass_lower_empty:n 
  { V,  o, e }
\cs_new:Npn \__zsect_ltx_mark_end: 
  { \if@nobreak\ifvmode\nobreak\fi\fi }
\NewDocumentCommand{\zsecmarkinsert}{mm}
  {
    \zsect_mark_insert:nn {#1}{#2}
  }
\DeclareDocumentCommand{\markright}{m}
  { 
    \zsect_right_mark_insert:n {#1}
    \__zsect_ltx_mark_end: 
  }
\DeclareDocumentCommand{\markboth}{mm}
  { 
    \mark_insert:nn { ztex-left} {#1}
    \zsect_right_mark_insert:n {#2}
    \__zsect_ltx_mark_end:
  }
\IfClassLoadedTF{book}
  {
    \DeclareDocumentCommand{\chaptermark}{m}
      { \zsect_mark_insert:nn {chapter}{#1} }
    \DeclareDocumentCommand{\sectionmark}{m}
      { \zsect_mark_insert:nn {section}{#1} }
  }{
    \DeclareDocumentCommand{\sectionmark}{m}
      { \zsect_mark_insert:nn {section}{#1} }
    \DeclareDocumentCommand{\subsectionmark}{m}
      { \zsect_mark_insert:nn {subsection}{#1} }
  }
\cs_new_protected:Npn \zsect_robust_left_mark:
  { \mark_use_first:nn {page}{ ztex-left } }
\cs_new_protected:Npn \zsect_robust_right_mark:
  {
    \mark_if_eq:nnnnTF {page}{ztex-right-nonempty}{top}{first}
      {
        \( \langle\mbox{empty}\rangle \)
        \ztex_msg_warn:n { right-mark-empty }
      }{ \mark_use_first:nn {page}{ztex-right-nonempty} }
  }
\cs_set:Npn \leftmark  { \mark_use_last:nn {page}{ztex-left} }
\cs_set:Npn \rightmark { \mark_use_first:nn {page}{ztex-right} }
\cs_set_eq:NN \ztexleftmark  \zsect_robust_left_mark:
\cs_set_eq:NN \ztexrightmark \zsect_robust_right_mark:
\cs_set_eq:NN \robustleftmark  \zsect_robust_left_mark:
\cs_set_eq:NN \robustrightmark \zsect_robust_right_mark:
\ztex_msg_set:nn { right-mark-empty }
  { right~mark~is~empty~at~page:\thepage. }


% ==> title interface (title = num + name)
\NewTemplateType{ztexsect}{4}
\DeclareTemplateInterface{ztexsect}{default}{4}
  {
    type            : tokenlist,
    hang            : boolean   = { false },
    break           : tokenlist,
    pagestyle       : tokenlist,
    afterindent     : boolean   = { false },

    space.before    : skip,
    space.after     : skip,
    space.left      : length,

    title.inline    : boolean    = { false }, 
    title.format    : tokenlist,
    title.format+   : tokenlist  = { },
    title.before    : tokenlist  = { },
    title.after     : tokenlist  = { \par },

    name.sep        : length     = { 0pt },
    name.before     : tokenlist  = { },
    name.after      : tokenlist  = { },
    name.format     : tokenlist  = { },
    name.format+    : tokenlist  = { },

    num             : tokenlist  = { },
    num.show        : boolean    = { true },
    num.sep         : length,
    num.with        : tokenlist  = { },
    num.format      : tokenlist  = { },
    num.format+     : tokenlist  = { },
    num.before      : tokenlist  = { },
    num.after       : tokenlist  = { },

    format.num      : tokenlist  = \KeyValue { num.format },
    format.num+     : tokenlist  = \KeyValue { num.format+ },
    format.name     : tokenlist  = \KeyValue { name.format },
    format.name+    : tokenlist  = \KeyValue { name.format+ },
    format.title    : tokenlist  = \KeyValue { title.format },
    format.title+   : tokenlist  = \KeyValue { title.format+ },

    explicit        : boolean    = { false },
    code            : tokenlist  = { },

    bookmark.num    : boolean    = false,
    bookmark.before : tokenlist,
    bookmark.after  : tokenlist,
  }
\DeclareTemplateCode{ztexsect}{default}{4}
  {
    type            = \l__zsect_title_type_tl,
    hang            = \l__zsect_title_hang_bool,     % TODO: implement it !
    break           = \l__zsect_title_break_tl,      % TODO: implement it !
    pagestyle       = \l__zsect_title_pagestyle_tl,
    afterindent     = \l__zsect_title_afterindent_bool,

    space.before    = \l__zsect_title_spbf_skip,
    space.after     = \l__zsect_title_spaf_skip,
    space.left      = \l__zsect_title_left_dim,

    format.num      = \l__zsect_title_num_format_tl, 
    format.num+     = \l__zsect_title_num_format_p_tl, 
    format.name     = \l__zsect_title_name_format_tl, 
    format.name+    = \l__zsect_title_name_format_p_tl, 
    format.title    = \l__zsect_title_format_tl, 
    format.title+   = \l__zsect_title_format_p_tl, 

    title.inline    = \l__zsect_title_inline_bool,
    title.format    = \l__zsect_title_format_tl,
    title.format+   = \l__zsect_title_format_p_tl,
    title.before    = \l__zsect_title_before_tl,
    title.after     = \l__zsect_title_after_tl,

    name.sep        = \l__zsect_title_name_sep_dim,
    name.format     = \l__zsect_title_name_format_tl,
    name.format+    = \l__zsect_title_name_format_p_tl,
    name.before     = \l__zsect_title_name_before_tl,
    name.after      = \l__zsect_title_name_after_tl,

    num             = \l__zsect_title_num_tl,
    num.show        = \l__zsect_title_num_show_bool,
    num.sep         = \l__zsect_title_num_sep_dim,
    num.with        = \l__zsect_title_num_width_tl,  % TODO: implement it !
    num.format      = \l__zsect_title_num_format_tl,
    num.format+     = \l__zsect_title_num_format_p_tl,
    num.before      = \l__zsect_title_num_before_tl,
    num.after       = \l__zsect_title_num_after_tl,

    explicit        = \l__zsect_title_explicit_bool,
    code            = \l__zsect_title_code_tl,

    bookmark.num    = \l__zsect_title_bookmark_num_bool,
    bookmark.before = \l__zsect_title_bookmark_before_tl,
    bookmark.after  = \l__zsect_title_bookmark_after_tl,
  }{
    % Instance args spec:
    %   #1: class name 
    %   #2: bool:\c_true_bool(numberless)|\c_false_bool;
    %   #3: toc-content
    %   #4: sec-content
    % NOTE: 
    % 1. sectioning hooks will be added by 'lthooks.dtx'.
    % 2. '\refstepcounter' can NOT be inside a group, and 
    %    should be after '\__zsect_title_pagespec_before:'.
    \group_begin:
      \AssignTemplateKeys
      \__zsect_title_pagespec_before:
    \group_end:
    \__zsect_title_cnt_refstep:nn { #2 }{ #1 }
    \group_begin:
      \AssignTemplateKeys
      \edef\zsect@num
        {
          \tl_if_empty:NTF \l__zsect_title_num_tl 
            { \cs:w the#1 \cs_end: }
            { \l__zsect_title_num_tl }
        }
      \edef\zsect@tocnum
        {
          \ztexhyperTF
            { \cs:w theH#1 \cs_end: }
            { \cs:w the #1 \cs_end: }
        }
      \__zsect_mark_update:nn { #1 }{ #4 }
      \__zsect_title_typeset:nnnn { #1 }{ #2 }{ #3 }{ #4 }
      \__zsect_title_pagespec_after:
      \group_insert_after:N \g__zsect_after_group_tl
    \group_end:
    \tl_gclear:N \g__zsect_after_group_tl
  }


% --->    inner components of title below   <----
\cs_new:Npn \__zsect_title_typeset:nnnn #1#2#3#4
  {
    \bool_if:NTF \l__zsect_title_explicit_bool 
      {
        \cs_set:Npn \zsecnum  { \zsect@num }
        \cs_set:Npn \zsecname { #4 }
        \l__zsect_title_code_tl
      }{
        \bool_if:nF { #2 }
          {
            % 1. set '\Hy@pdfstring' true to support command '\texorpdfstring';
            % 2. non-empty toc name(#1) comes before the sec name(#2);
            % 3. command or math shift may occur in '#1'(i.e. toc name), thus
            %    '\texorpdfstring' need to work well in toc name.
            \__zsect_bookmark_update:nnn { #1 }{ #3 }{ #4 }
            \__zsect_title_toc_add:nnn   { #1 }{ #3 }{ #4 }
          }
        \__zsect_title_space_before:
        \__zsect_title_space_left:
        \group_begin:
          \__zsect_title_body:nn { #4 }{ #2 }
        \group_end:
        \__zsect_title_space_after:
      }
  }
\cs_new:Npn \__zsect_mark_update:nn #1#2
  {
    \zsect_mark_insert:nn { #1 }{ #2 }
    % \zsect_markclass_lower_empty:n { #1 }
  }
\cs_new:Npn \__zsect_bookmark_update:nnn #1#2#3
  {
    \bool_if:NT \g__ztex_hyperref_bool 
      {
        \group_begin:
          \Hy@pdfstringtrue
          % NOTE: do NOT apply '\zsect_unexpand_protect:'
          %       to command '\pdfboomark'.
          \zsect_unexpand_protect:
            \xdef\zsect@temp@a
              { \tl_if_empty:nTF {#2}{#3}{#2} }
          \zsect_restore_protect:
          \exp_after:wN \__zsect_title_bookmark_add:nn 
            \exp_after:wN { \zsect@temp@a }{ #1 }
        \group_end:
        \cs_undefine:N \zsect@temp@a
      }
  }
% ------------------------------------------
\cs_new:Npn \__zsect_title_cnt_refstep:nn #1#2 
  {
    \bool_if:nTF { #1 }
      { \stepcounter{#2} }
      { \refstepcounter{#2} }
  }
\cs_new:Npn \__zsect_title_bookmark_add:nn #1#2
  {% #2:class; #1:can only have valid pdfstring !!!
    \zsect_bookmark_add:eee
      {
        \prop_item:Nn \c_zsect_level_prop 
          { #2 }
      }{
        \l__zsect_title_bookmark_before_tl
          \bool_if:NT \l__zsect_title_bookmark_num_bool 
            { \zsect@tocnum\ }
          \exp_not:n { #1 }
        \l__zsect_title_bookmark_after_tl
      }
      { #2.\zsect@tocnum }
  }
% page spec
\cs_new:Npn \__zsect_title_pagespec_before:
  {
    \bool_if:NF \l__zsect_title_explicit_bool
      {
        \__zsect_title_type_spec:nn { page, top }
          { \newpage\hspace{0pt} }
        \tl_if_empty:NF \l__zsect_title_pagestyle_tl
          { 
            \exp_args:No \thispagestyle 
              { \l__zsect_title_pagestyle_tl } 
          }
      }
  }
\cs_new:Npn \__zsect_title_pagespec_after:
  {
    \bool_if:NF \l__zsect_title_explicit_bool
      {
        \__zsect_title_type_spec:nn { page }
          { \hspace{0pt}\newpage }
      }
  }
\cs_new:Npn \__zsect_title_type_spec:nn #1#2 
  {
    \exp_args:Nne \clist_if_in:nnT { #1 }
      { \l__zsect_title_type_tl }{ #2 }
  }
% space spec
\cs_new:Nn \__zsect_title_space_before: 
  {
    \exp_args:Nne \clist_if_in:nnTF {page, top}{\l__zsect_title_type_tl}
      { \vskip\l__zsect_title_spbf_skip\relax }
      {
        \if@noskipsec \leavevmode \fi \par
        \zsect@dim@b \l__zsect_title_spbf_skip\relax
        \ifdim \zsect@dim@b < \z@
          \zsect@dim@b -\zsect@dim@b\relax
        \fi
        \if@nobreak 
          \everypar{} 
        \else
          \addpenalty \@secpenalty
          \addvspace \zsect@dim@b
        \fi
      }
  }
\tl_gclear_new:N \g__zsect_after_group_tl
\cs_new:Nn \__zsect_title_space_after: 
  {
    \bool_if:NTF \l__zsect_title_inline_bool 
      { \hskip \l__zsect_title_spaf_skip\relax }
      {
        \vskip \l__zsect_title_spaf_skip\relax
        \bool_if:NTF \l__zsect_title_afterindent_bool
          { \tl_gset:Nn \g__zsect_after_group_tl {\@afterindenttrue } }
          { \tl_gset:Nn \g__zsect_after_group_tl {\@afterindentfalse} }
        \tl_gput_right:Nn \g__zsect_after_group_tl {\@afterheading}
      }
  }
\cs_new:Nn \__zsect_title_space_left: 
  {
    \noindent\hspace*{\l__zsect_title_left_dim}
  }
% title body
\cs_new:Npn \__zsect_title_body:nn #1#2
  {% #1:name; #2:bool
    \l__zsect_title_format_tl
    \l__zsect_title_format_p_tl
    \l__zsect_title_before_tl
    \bool_if:nT { #2 }
      { \bool_set_false:N \l__zsect_title_num_show_bool }
    \bool_if:NT \l__zsect_title_num_show_bool
      {
        {
          \l__zsect_title_num_before_tl
          \l__zsect_title_num_format_tl
          \l__zsect_title_num_format_p_tl 
            \zsect@num
          \l__zsect_title_num_after_tl 
        }
        \hskip \l__zsect_title_num_sep_dim\relax
      }
    {
      \l__zsect_title_name_format_tl
      \l__zsect_title_name_format_p_tl
      \l__zsect_title_name_before_tl
        #1
      \l__zsect_title_name_after_tl
    }
    \hskip \l__zsect_title_name_sep_dim\relax
    \l__zsect_title_after_tl
  }
% --->    inner components of title above   <----


% ==> define title
\cs_new:Npn \zsect_define_title:Nnn #1#2#3
  {% #1:cmd; #2:style; #3:keyval
    % setup instance 
    \cs_if_exist:cF { c@\cs_to_str:N #1 } 
      {
        \exp_args:Ne \newcounter{\cs_to_str:N #1} 
      }
    \exp_args:Ne \__zsect_setup_instance:nn 
      { \cs_to_str:N #1 @#2 }{ #3 }
    % check if instance valid:
    % \edef\valid@sect@instance
    %   {
    %     \zsect_instance_set_fallback:nn 
    %       {#1}
    %       {#2}
    %   }
    % use instance:
    \DeclareDocumentCommand{ #1 }{sO{}m}
      {
        \IfBooleanTF{##1}
          {
            \exp_args:Neee \UseInstance{ztexsect}
              { \cs_to_str:N #1 @\g__zsect_title_style_tl-numberless }
              { \cs_to_str:N #1 }
              { \c_true_bool }{ ##2 }{ ##3 }
          }{
            \exp_args:Neee \UseInstance{ztexsect}
              { \cs_to_str:N #1 @\g__zsect_title_style_tl }
              { \cs_to_str:N #1 }
              { \c_false_bool }{ ##2 }{ ##3 }
          }
      }
  }
\cs_new:Npn \zsect_instance_set_fallback:nn #1#2
  {
    \IfInstanceExistsTF{#1}
      { #1 }
      { #2 }
  }
\cs_generate_variant:Nn \zsect_define_title:Nnn 
  { No, Ne, c, co, ce }
\cs_new_protected:Npn \__zsect_setup_instance:nn #1#2
  {
    \DeclareInstance{ztexsect}{#1}
      { default }{ #2 }
    \DeclareInstanceCopy{ztexsect}
      { #1-numberless }{ #1 }
  }
\zsect_define_title:Nnn \part { ltx } 
  {
    type         = page,
    pagestyle    = empty,
    space.before = 0pt \@plus .7fill,
    space.after  = 0pt \@plus 1fill,
    title.format = \huge\bfseries\centering,
    num          = \Roman{part}\par,
    num.before   = {PART~},
    num.sep      = 0pt,
  }
\zsect_define_title:Nnn \chapter { ltx }
  {
    type         = top,
    pagestyle    = plain,
    space.before = 50pt,
    space.after  = 40pt,
    title.format = \normalfont\huge\bfseries\centering,
    num          = \Roman{chapter},
    num.before   = {CHAP~},
    num.sep      = 15pt,
  }
\zsect_define_title:Nnn \section { ltx }
  {
    type         = normal,
    space.left   = 0pt,
    space.before = -3.5ex \@plus -1ex \@minus -.2ex,
    space.after  = 2.3ex \@plus .2ex,
    title.format = \normalfont\Large\bfseries,
    num.sep      = 18pt,
  }
\zsect_define_title:Nnn \subsection { ltx } 
  {
    type         = normal,
    space.left   = 0pt,
    space.before = -3.25ex\@plus -1ex \@minus -.2ex,
    space.after  = 1.5ex \@plus .2ex,
    title.format = \normalfont\large\bfseries,
    num.sep      = 15pt,
  }
\zsect_define_title:Nnn \subsubsection { ltx }
  {
    type         = normal,
    space.left   = 0pt,
    space.before = -3.25ex\@plus -1ex \@minus -.2ex,
    space.after  = 1.5ex \@plus .2ex,
    title.format = \normalfont\normalsize\bfseries,
    num.sep      = 13pt,
  }
\zsect_define_title:Nnn \paragraph { ltx }
  {
    type         = normal,
    title.inline = true,
    title.after  = ,
    space.left   = 0pt,
    space.before = 3.25ex \@plus 1ex \@minus .2ex,
    space.after  = -1em,
    title.format = \normalfont\normalsize\bfseries,
    num.show     = false,
    name.sep     = 18pt,
  }
\zsect_define_title:Nnn \subparagraph { ltx }
  {
    type         = normal,
    title.inline = true,
    title.after  = ,
    space.left   = 18pt,
    space.before = 3.25ex \@plus 1ex \@minus .2ex,
    space.after  = -1em,
    title.format = \normalfont\normalsize\bfseries,
    num.show     = false,
    name.sep     = 19pt,
  }
\NewDocumentCommand{\zsecdefine}{mmm}
  {
    \zsect_define_title:Nnn #1 
      { #2 }{ #3 }
  }


% ==> custom interface for user
% sec title style
\NewDocumentCommand{\zsectitlestyle}{m}
  {
    \tl_gset:Nn \g__zsect_title_style_tl
      { #1 }
  }
\@onlypreamble\zsectitlestyle

% sec title format
\NewDocumentCommand{\zsecformat}{s O{ltx} m +m}
  {
    \clist_map_inline:nn { #3 }
      {
        \edef\zsect@tmp@instance@name
          { \cs_to_str:N ##1 @#2\IfBooleanT{#1}{-numberless} }
        \IfInstanceExistsTF {ztexsect}{ \zsect@tmp@instance@name }
          {
            \exp_args:Nne \EditInstance{ztexsect}
              { \zsect@tmp@instance@name }
              { #4 }
          }{
            \ztex_msg_set:nn {zsect@instance@nonexist}
              { Instance~'\zsect@tmp@instance@name'~of~
                TemplateType~'ztexsect'~does~NOT~exist. }
            \ztex_msg_error:n {zsect@instance@nonexist}
          }
      }
    \cs_undefine:N \zsect@tmp@instance@name
  }

% template defaults & one-time title
\NewDocumentCommand{\zsecTemplateDefaultsEdit}{m}
  {
    \EditTemplateDefaults{ztexsect}{default}
      { #1 }
  }
\cs_new_protected:Npn \zsect_once_title:nnnnn #1#2#3#4#5
  {
    \UseTemplate{ztexsect}{default}{ #1 }
      { #2 }{ #3 }{ #4 }{ #5 }
  }
\cs_generate_variant:Nn \zsect_once_title:nnnnn 
  { no, ne, ooooo, eeeee }
\NewDocumentCommand{\zsectitleOnce}{smmO{}m}
  {
    \zsect_once_title:nnnnn 
      { #3 } % keyval settings
      { #2 } % class
      { \IfBooleanTF{#1}{\c_true_bool}{\c_false_bool} }
      { #4 } % toc content
      { #5 } % sec content
  }


% new NewTemplateType from scratch
\cs_new_protected:Npn \zsect_new_templatetype:nn #1#2
  { 
    \NewTemplateType{zsect#1}{#2}
  }
\cs_new_protected:Npn \zsect_declare_template_interface:nnnn #1#2#3#4
  {
    \DeclareTemplateInterface{zsect#1}{#2}
      {#3}{#4}
  }
\cs_new_protected:Npn \zsect_declare_template_code:nnnnn #1#2#3#4#5
  {
    \DeclareTemplateCode{zsect#1}{#2}
      {#3}{#4}{#5}
  }