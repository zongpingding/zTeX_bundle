\ProvidesExplFile{ztex.module.font.tex}
  {2025/09/03}{\ztex@versi@n}
  {font~module~for~ztex}


%%%%%     font module for ztex     %%%%%
\bool_if:NT \g__ztex_sysfont_cfg_bool 
  {
    \RequirePackage{fontspec}
  }
\cs_set_protected:Npn \ztex_font_set:n #1
  {
    \ztex_keys_set:nn { font }{#1}
  }
\NewDocumentCommand{\zfontset}{m}
  {
    \ztex_font_set:n {#1}
  }
% reset text font to the default computer modern
\NewDocumentCommand{\resetfont}{O{cm}}
  {
    \str_case:nnT { #1 }
      {
        {cm}{
          \renewcommand\rmdefault{cmr}
          \renewcommand\sfdefault{cmss}
          \renewcommand\ttdefault{cmtt}
        }
        {lm}{
          \renewcommand\rmdefault{lmr}
          \renewcommand\sfdefault{lmss}
          \renewcommand\ttdefault{lmtt}
        }
      }{ \normalfont }
  }


% ==> patches:
% symbols:
\DeclareMathSymbol{\blacktriangleright}{\mathrel}{AMSa}{"49}
\cs_new:Nn \__ztex_text_symbol_patch: 
  {
    \let\oldtextbullet\textbullet
    \DeclareTextFontCommand{\zslideCmsyOms}
      {\fontfamily{cmsy}\fontencoding{OMS}\selectfont}
    \DeclareRobustCommand{\textbullet}
      {\zslideCmsyOms\oldtextbullet}
  }
% cancel CJKecglue(use it inside a group)
% NOTE: default 'CJKecglue' is one space.
\cs_new_protected:Nn \zfont_cancel_CJKecglue:
  {
    \str_if_eq:VnT \g__ztex_lang_str { cn }
      {
        \xeCJKsetup
          {
            CJKecglue = {\hskip 0pt plus 0.08\baselineskip}
          }
      }
  }
\cs_new_protected:Nn \zfont_restore_CJKecglue:
  {
    \str_if_eq:VnT \g__ztex_lang_str { cn }
      {
        \xeCJKsetup
          {
            CJKecglue = { \tex_space:D }
          }
      }
  }
\cs_new_protected:Npn \removeCJKecglue 
  { \zfont_cancel_CJKecglue: }
\cs_new_protected:Npn \restoreCJKecglue 
  { \zfont_restore_CJKecglue: }


% ==> using system fonts
%%%%%                 NOTE                  %%%%%
% 1. MOST FONTS only have a limited set of FEATURES 
% 2. MOST CJK fonts' features are not equal to western fonts.
\ztex_keys_define:nn { fontcfg / new }
  {
    name     .tl_set:N  = \l__ztex_fontcfg_new_name_tl, % font name / file name
    path     .tl_set:N  = \l__ztex_fontcfg_new_path_tl,
    path     .initial:n = { },
    feat     .meta:nn   = { ztex / fontcfg / new / feat }{#1},
    feat / ext             .tl_set:N   = \l__ztex_fontcfg_new_ext_tl,
    feat / Extension       .meta:n     = { feat / ext = #1 },
    feat / ext             .initial:n  = {  }, % extension
    feat / up              .tl_set:N   = \l__ztex_fontcfg_new_up_tl,
    feat / UprightFont     .meta:n     = { feat / up = #1 },
    feat / up              .initial:n  = { * }, % *-regular
    feat / sl              .tl_set:N   = \l__ztex_fontcfg_new_sl_tl,
    feat / SlantedFont     .meta:n     = { feat / sl = #1 },
    feat / sl              .initial:n  = { * }, % *-slant
    feat / sc              .tl_set:N   = \l__ztex_fontcfg_new_sc_tl,
    feat / SmallCapsFont   .meta:n     = { feat / sc = #1 },
    feat / sc              .initial:n  = { * }, % *-smallcaps
    feat / bd              .tl_set:N   = \l__ztex_fontcfg_new_bd_tl,
    feat / BoldFont        .meta:n     = { feat / bd = #1 },
    feat / bd              .initial:n  = { * }, % *-bold 
    feat / it              .tl_set:N   = \l__ztex_fontcfg_new_it_tl,
    feat / ItalicFont      .meta:n     = { feat / it = #1 },
    feat / it              .initial:n  = { * }, % *-italic
    feat / bdit            .tl_set:N   = \l__ztex_fontcfg_new_bdit_tl,
    feat / BoldItalicFont  .meta:n     = { feat / bdit = #1 },
    feat / bdit            .initial:n  = { * }, % *-bolditalic
    feat / bdsl            .tl_set:N   = \l__ztex_fontcfg_new_bdsl_tl,
    feat / BoldSlantedFont .meta:n     = { feat / bdsl = #1 },
    feat / bdsl            .initial:n  = { * }, % *-boldslant
    feat / other           .tl_set:N   = \l__ztex_fontcfg_new_other_tl,
    feat / other           .initial:n  = {  },  % other fontspec config
  }

\ztex_msg_set:nn { fontcfg / lang }{ Current~font~type~supported~are:'en',~'CJK'. }
\cs_set:Npn \__ztex_fontcfg_newfamily_copy:nnnnn #1#2#3#4#5 
  {% #1:font cmd; #2:font file path(format 'Path=xxx,'); 
   % #3:font file name; #4:font feat;  #5:en/CJK
    \str_case:nnF {#5}
      {
        {en}{
          \exp_args:Nc \setfontfamily{zfont@#1}{#3}[#2 #4]
          \exp_args:Nc \NewDocumentCommand { #1 }{}
            {
              \use:c {zfont@#1}
            }
        }
        {CJK}{
          \setCJKfamilyfont{zfont@#1}{#3}[#2 #4]
          \exp_args:Nc \NewDocumentCommand { #1 }{}
            {
              \CJKfamily{zfont@#1}
            }
        }
        {en/CJK}{
          \setCJKfamilyfont{zfont@#1}{#3}[#2 #4]
          \exp_args:Nc \setfontfamily{zfont@#1}{#3}[#2 #4]
          \exp_args:Nc \NewDocumentCommand { #1 }{}
            {
              \use:c {zfont@#1}
              \CJKfamily{zfont@#1}
            }
        }
      }{
        \ztex_msg_error:n { fontcfg / new }
      }
  }
\cs_generate_variant:Nn \__ztex_fontcfg_newfamily_copy:nnnnn {ooooo}
\cs_new_protected:Npn \__ztex_sysfont_new:nnn #1#2#3
  {% #1:en/cn; #2:cmd; #3:key-value(font cfg args)
    \ztex_keys_set:nn { fontcfg / new } {#3}
    \__ztex_fontcfg_newfamily_copy:ooooo 
      { #2 }
      { 
        \tl_if_empty:VF \l__ztex_fontcfg_new_path_tl 
          { Path=\l__ztex_fontcfg_new_path_tl, }
      }
      { \l__ztex_fontcfg_new_name_tl }
      {
        \tl_if_empty:VF \l__ztex_fontcfg_new_ext_tl
          { Extension   = \l__ztex_fontcfg_new_ext_tl, }
        UprightFont = \l__ztex_fontcfg_new_up_tl,
        BoldFont    = \l__ztex_fontcfg_new_bd_tl,
        ItalicFont  = \l__ztex_fontcfg_new_it_tl,
        SlantedFont = \l__ztex_fontcfg_new_sl_tl,
        SmallCapsFont   = \l__ztex_fontcfg_new_sc_tl,
        BoldItalicFont  = \l__ztex_fontcfg_new_bdit_tl,
        BoldSlantedFont = \l__ztex_fontcfg_new_bdsl_tl,
        \l__ztex_fontcfg_new_other_tl % other fontspec config
      }{ #1 }
    % Reset key value, '\cs{group_end:}' conflict with '\cs{newfontfamily}',
    % See also: https://tex.stackexchange.com/q/729765/294585.
    \ztex_keys_set:nn { fontcfg / new }
      {
        path = ,
        feat / ext  = ,
        feat / up   = *, 
        feat / bd   = *,
        feat / it   = *,
        feat / sl   = *,
        feat / sc   = *,
        feat / bdsl = *,
        feat / bdit = *,
        feat / other = ,
      }
  }
\bool_if:NTF \g__ztex_sysfont_cfg_bool
  {
    \__ztex_sysfont_new:nnn {en}{cinzel}
      {
        name = Cinzel-Regular.ttf,
        feat / bd   = Cinzel-Bold,
        feat / it   = ParsiMatn-Italic,
      }
  }{ \def\cinzel{\relax} }
\NewDocumentCommand{\zfontfamilynew}{O{en/CJK}mm}
  {
    \__ztex_sysfont_new:nnn 
      { #1 }
      { \cs_to_str:N #2 }
      { #3 }
  }


% TARGET: \zfontset{en={main=, sans=}, CJK={main=, mono=}}
% Is this interface too complex ???
\ztex_keys_define:nn { fontcfg / set }
  {
    lang    .multichoices:nn = {en, CJK}{},
  }
\cs_new_protected:Npn \__ztex_docfont_set:nn #1#2
  {% #1: roman,sans,mono; #2:font family
    \__ztex_fontcfg_setfamily_copy:ooooo 
      { #1 }{ #2 }{}{}{}
  }
\NewDocumentCommand{\zfontfamilyset}{O{en}m}
  { }
\ztex_msg_set:nn { fontcfg / family }
  { Valid~family~options~are:'main',~'sans'~and~'mono'. }
\cs_set:Npn \__ztex_fontcfg_setfamily_copy:nnnn #1#2#3#4
  {% #1:lang, #2:family, #3:font, #4: font features
    \tl_if_in:nnF {en, CJK}{#1}
      { \ztex_msg_error:n { fontcfg / lang } }
    \tl_if_in:nnF {main, sans, mono}{#2}
      { \ztex_msg_error:n { fontcfg / family } }
    \cs:w set #1 #2 font\cs_end: {#3}{#4}
  }
\cs_generate_variant:Nn \__ztex_fontcfg_setfamily_copy:nnnn {oooo}