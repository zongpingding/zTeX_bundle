\NeedsTeXFormat{LaTeX2e}
\RequirePackage{expl3}
\ProvidesExplPackage{ztool}{2024/12/17}{1.0.0}{A~pre-release~tool~package~for~LaTeX}


% ==> Shell escape tool 
% NOTE: Copy of the original 'l3sys-shell' + some modifications
% windows path handle
\cs_new:Npn \ztool_sys_path_to_win:N #1 
  {
    \quark_if_nil:NF #1 {
      \token_if_eq_meaning:NNTF #1 /
        { \c_backslash_str }
        {#1}
      \ztool_sys_path_to_win:N
    }
  }
\cs_new:Npn \ztool_sys_path_to_win:w #1 ~ #2 \q_stop
  {
    \ztool_sys_path_to_win:N #1 \q_nil
    \tl_if_empty:nF {#2}
      {
        \c_space_tl
        \__sys_path_to_win:w #2 \q_stop
      }
  }
\cs_new:Npn \ztool_sys_path_to_win:n #1
  {
    \exp_after:wN \ztool_sys_path_to_win:w \tl_to_str:n {#1} ~ \q_stop
  }
% respective commands
\cs_new_protected:Npn \ztool_shell_escape:n #1
  {
    \sys_if_shell_unrestricted:T
      { \sys_shell_now:n {#1} }
  }
\cs_generate_variant:Nn \ztool_shell_escape:n {e}
\cs_new_protected:Npe \ztool_shell_mkdir:n #1
  {
    \ztool_shell_escape:e {
      \sys_if_platform_unix:T 
        {mkdir~-p~\exp_not:N \tl_to_str:n {#1}}
      \sys_if_platform_windows:T
        {mkdir~ \exp_not:N \ztool_sys_path_to_win:n {#1}}
    }
  }
\cs_new_protected:Npe \ztool_shell_cp:nn #1#2
  {
    \ztool_shell_escape:e {
      \sys_if_platform_unix:T
        {
          cp~-f~ \exp_not:N \tl_to_str:n {#1} ~
            \exp_not:N \tl_to_str:n {#2}
        }
      \sys_if_platform_windows:T
        {% can NOT use wildcards in CMD
          copy~/y~ \exp_not:N \ztool_sys_path_to_win:n {#1} ~
            \exp_not:N \ztool_sys_path_to_win:n {#2}
        }
    }
  }
\cs_new_protected:Npe \ztool_shell_mv:nn #1#2
  {
    \ztool_shell_escape:e {
      \sys_if_platform_unix:T
        {
          mv~ \exp_not:N \tl_to_str:n {#1} ~
            \exp_not:N \tl_to_str:n {#2}
        }
      \sys_if_platform_windows:T
        {
          copy~/y~ \exp_not:N \ztool_sys_path_to_win:n {#1} ~
            \exp_not:N \ztool_sys_path_to_win:n {#2}
            \token_to_str:N & \token_to_str:N &
            del~/f~/q~\exp_not:N \ztool_sys_path_to_win:n {#1}
        }
    }
  }
\cs_new_protected:Npe \ztool_shell_rm:n #1
  {
    \ztool_shell_escape:e {
      \sys_if_platform_unix:T
        { rm~-f~ \exp_not:N \tl_to_str:n {#1}  }
      \sys_if_platform_windows:T
        { del~/f~/q~ \exp_not:N \ztool_sys_path_to_win:n {#1} }
    }
  }
\cs_new_protected:Npe \ztool_shell_rmdir:n #1
  {
    \ztool_shell_mkdir:n {#1}
    \ztool_shell_escape:e {
      \sys_if_platform_unix:T
        { rm~-rf~ \exp_not:N \tl_to_str:n {#1} }
      \sys_if_platform_windows:T
        { rmdir~/s~/q~ \exp_not:N \ztool_sys_path_to_win:n {#1} }
    }
  }
\tl_new:N \l__ztool_shell_tmp_tl
\cs_new_protected:Npe \ztool_get_shell_pwd:N #1
  {
    \exp_not:N \sys_get_shell:nnN
      {
        \sys_if_platform_unix:T { pwd }
        \sys_if_platform_windows:T { cd }
      }{
        \char_set_catcode_other:N \exp_not:N \\
        \char_set_catcode_other:N \exp_not:N \#
        \char_set_catcode_other:N \exp_not:N \~
        \char_set_catcode_other:N \exp_not:N \%
        \char_set_catcode_space:N \exp_not:N \ %
        \tex_endlinechar:D -1 \scan_stop:
      }
    \exp_not:N \l__ztool_shell_tmp_tl
    \str_set:NV #1 \exp_not:N \l__ztool_shell_tmp_tl
  }
\cs_new_protected:Npe \ztool_shell_split_ls:nN #1#2
  {
    \exp_not:N \sys_get_shell:nnN
      {
        \sys_if_platform_unix:T { ls~-1~ #1 }
        \sys_if_platform_windows:T { dir~/b~ #1 }
      }{
        \ExplSyntaxOff
        \char_set_catcode_other:N \exp_not:N \\
        \char_set_catcode_other:N \exp_not:N \#
        \char_set_catcode_other:N \exp_not:N \~
        \char_set_catcode_other:N \exp_not:N \%
        \char_set_catcode_other:n { 13 }
      }
      \exp_not:N \l__ztool_shell_tmp_tl
    \str_set:NV \exp_not:N \l__sys_tmp_tl \exp_not:N \l__sys_tmp_tl
    \seq_set_split:NnV #2 
      { \char_generate:nn { `\^^M } { 12 } }
      \exp_not:N \l__ztool_shell_tmp_tl
    \seq_pop_right:NN #2 \exp_not:N \l__sys_tmp_tl
  }
\cs_generate_variant:Nn \ztool_shell_mkdir:n {e}
\cs_generate_variant:Nn \ztool_shell_cp:nn { ee, ne, en }
\cs_generate_variant:Nn \ztool_shell_mv:nn { ee, ne, en }
\cs_generate_variant:Nn \ztool_shell_rm:nn { e, f, o }
\cs_generate_variant:Nn \ztool_shell_rmdir:nn { e, f, o }
\cs_generate_variant:Nn \ztool_get_shell_pwd:N {c}
\cs_generate_variant:Nn \ztool_shell_split_ls:nN {nc}


% ==> IO operations
\ior_new:N \g_ztool_file_read_ior
\ior_new:N \g_ztool_file_append_ior
\iow_new:N \g_ztool_file_append_iow
\tl_new:N \l_ztool_current_line
\str_clear:N \l_ztikz_file_ori_content_str
\seq_new:N \l_ztool_file_seq
\cs_new_protected:Npn \ztool_read_file_as_seq:nnN #1#2#3 
  {% #1: bool(True to keep spaces, False to trim); #2: file name; #3: seq
    \seq_clear:N #3
    \file_if_exist:nT {#2}
      {
        \ior_open:Nn \g_ztool_file_read_ior {#2}
        \ior_map_inline:Nn \g_ztool_file_read_ior
          {
            \bool_if:nTF {#1}
              { \seq_put_right:Nn #3 {##1} }
              { \seq_put_right:Nn #3 {\tl_trim_spaces:n {##1}} }
          }
        \ior_close:N \g_ztool_file_read_ior
      }
  }
\cs_new_protected:Npn \ztool_gread_file_as_seq:nnN #1#2#3 
  {% #1: bool(True to keep spaces, False to trim); #2: file name; #3: seq
    \seq_gclear:N #3
    \file_if_exist:nT {#2}
      {
        \ior_open:Nn \g_ztool_file_read_ior {#2}
        \ior_map_inline:Nn \g_ztool_file_read_ior
          {
            \bool_if:nTF {#1}
              { \seq_gput_right:Nn #3 {##1} }
              { \seq_gput_right:Ne #3 {\tl_trim_spaces:n {##1}} }
          }
        \ior_close:N \g_ztool_file_read_ior
      }
  }
\cs_generate_variant:Nn \ztool_read_file_as_seq:nnN { ne, nnc, nec }
\cs_generate_variant:Nn \ztool_gread_file_as_seq:nnN { ne, nnc, nec }

\cs_new_protected:Npn \ztool_file_new:nn #1#2
  {% #1: \c_true_bool to allow overwrite; #2: file name
    \bool_if:nT {#1}
      {
        \iow_open:Nn \g_ztool_file_append_iow {#2}
        \iow_close:N \g_ztool_file_append_iow
      }
  }
\cs_new_protected:Npn \ztool_append_to_file:nn #1#2 
  {% #1: file name; #2: content
    \seq_clear:N \l_ztool_file_seq
    \file_if_exist:nF {#1}{ \ztool_file_new:nn {\c_false_bool}{#1} }
    \ior_open:Nn \g_ztool_file_append_ior {#1}
    \ior_str_map_inline:Nn \g_ztool_file_append_ior 
      {
        \seq_put_right:Nn \l_ztool_file_seq 
          { ##1 }
      }
    \iow_open:Nn \g_ztool_file_append_iow {#1}  
    \iow_now:Ne \g_ztool_file_append_iow 
      { \seq_use:Nn \l_ztool_file_seq {^^J} }
    \iow_now:Ne \g_ztool_file_append_iow {#2}
    \iow_close:N \g_ztool_file_append_iow
  }
\cs_generate_variant:Nn \ztool_append_to_file:nn { no, nf, ne, ee }
\cs_new_protected:Npn \ztool_replace_file_line:nnn #1#2#3 
  {% #1:file name; #2:line index; #3:replacement
    \seq_clear:N \l_ztool_file_seq
    \file_if_exist:nT {#1}{
      \ior_open:Nn \g_ztool_file_read_ior {#1}
      \ior_str_map_inline:Nn \g_ztool_file_read_ior 
        {
          \seq_put_right:Nn \l_ztool_file_seq {##1}
        }
      \ior_close:N \g_ztool_file_read_ior
      \seq_set_item:Nnn \l_ztool_file_seq {#2} 
        { #3 }
      \iow_open:Nn \g_ztool_file_append_iow {#1}
      \iow_now:Ne \g_ztool_file_append_iow 
        { \seq_use:Nn \l_ztool_file_seq {^^J} }
      \iow_close:N \g_ztool_file_append_iow
    }
  }
\cs_generate_variant:Nn \seq_set_item:Nnn { Nne }
\cs_generate_variant:Nn \ztool_replace_file_line:nnn { e, ene, eee }
\cs_new_protected:Npn \ztool_insert_to_file:nnn #1#2#3
  {% #1:file name; #2:line index; #3:content
    \seq_clear:N \l_ztool_file_seq
    \file_if_exist:nT {#1}{
      \ior_open:Nn \g_ztool_file_read_ior {#1}
      \ior_str_map_inline:Nn \g_ztool_file_read_ior 
        {
          \seq_put_right:Nn \l_ztool_file_seq {##1}
        }
      \ior_close:N \g_ztool_file_read_ior
      \tl_set:No \l_ztool_current_line 
        { \seq_item:Nn \l_ztool_file_seq {#2} }
      \seq_set_item:Nne \l_ztool_file_seq {#2} 
        { #3^^J\l_ztool_current_line }
      \iow_open:Nn \g_ztool_file_append_iow {#1}
      \iow_now:Ne \g_ztool_file_append_iow 
        { \seq_use:Nn \l_ztool_file_seq {^^J} }
      \iow_close:N \g_ztool_file_append_iow
    }
  }
\cs_generate_variant:Nn \ztool_insert_to_file:nn { ne, nf, ee }

% ==> box manipulation tool
% catch box dimension
\box_new:N \l_ztool_measure_box
\cs_new:Npn \ztool_box_set_to:NNn #1#2#3 {
  \hbox_set:Nn \l_ztool_measure_box {#3}
  \dim_set:Nn #2 {#1 \l_ztool_measure_box}
  \box_set_eq:NN \l_ztool_measure_box \c_empty_box
}
\cs_new:Npn \ztool_box_gset_to:NNn #1#2#3 {
  \hbox_set:Nn \l_ztool_measure_box {#3}
  \dim_gset:Nn #2 {#1 \l_ztool_measure_box}
  \box_set_eq:NN \l_ztool_measure_box \c_empty_box
}
\cs_new:Npn \ztool_get_ht:Nn 
  { \ztool_box_set_to:NNn \box_ht:N }
\cs_new:Npn \ztool_get_wd:Nn  
  { \ztool_box_set_to:NNn \box_wd:N }
\cs_new:Npn \ztool_get_dp:Nn  
  { \ztool_box_set_to:NNn \box_dp:N }
\cs_new:Npn \ztool_gget_ht:Nn 
  { \ztool_box_gset_to:NNn \box_ht:N }
\cs_new:Npn \ztool_gget_wd:Nn  
  { \ztool_box_gset_to:NNn \box_wd:N }
\cs_new:Npn \ztool_gget_dp:Nn  
  { \ztool_box_gset_to:NNn \box_dp:N }
\cs_generate_variant:Nn \ztool_get_ht:Nn  { Ne, ce }
\cs_generate_variant:Nn \ztool_get_wd:Nn  { Ne, ce }
\cs_generate_variant:Nn \ztool_gget_ht:Nn { Ne, ce }
\cs_generate_variant:Nn \ztool_gget_wd:Nn { Ne, ce }
% resize box content
\cs_new_protected:Npn \ztool_set_to_wd:nn #1#2
  {% #1: object; #2: width
    \hbox_set:Nn \l_tmpa_box {#2}
    \box_resize_to_wd:Nn \l_tmpa_box {#1}
    \box_use:N \l_tmpa_box
  }
\cs_new_protected:Npn \ztool_set_to_ht:nn #1#2
  {% #1: object; #2: width
    \hbox_set:Nn \l_tmpa_box {#2}
    \box_resize_to_ht:Nn \l_tmpa_box {#1}
    \box_use:N \l_tmpa_box
  }
\cs_generate_variant:Nn \ztool_set_to_wd:nn { e, ne, ee }
\cs_generate_variant:Nn \ztool_set_to_ht:nn { e, ne, ee }