\ProvidesExplFile{ztikz.library.python.tex}{2024/10/24}{1.0.0}{python~library~for~ztikz}



% ==> writing scripts
\RequirePackage{xsimverb}
\__ztikz_load_module_library:nn {library}{pyscript}
\ztool_shell_mkdir:n {ztikz_output/python_data/}
\tl_const:Nn \g__ztikz_python_path_tl   {ztikz_output/python_data} 
\ior_new:N \g__file_read_ior
\tl_new:N \g__file_content_tl
\int_new:N \g__sympy_index_int
\int_new:N \g__python_picture_index_int
\int_gadd:Nn \g__python_picture_index_int {1}


% ==> core functions  
\cs_new_protected:Npn \zlatex_Readlines_cs:nn #1#2 
{
  \ior_open:Nn \g__file_read_ior {#2}
  \str_case:nnF {#1}{
    {raw}{
      \ior_get:NN \g__file_read_ior \g__file_content_tl
    }
    {str}{
      \ior_str_get:NN \g__file_read_ior \g__file_content_tl
    }
  }{}
  \tl_use:N \g__file_content_tl
}
\cs_generate_variant:Nn \zlatex_Readlines_cs:nn {ee}
\cs_generate_variant:Nn \xsim_file_write_start:nn {ne}


% ==> users' interface
% python-matplotlib
\NewDocumentEnvironment{pyfig}{ O{width=.75\linewidth}m }
  {
    \newcommand{\py@file}{#2}
    \xsim_file_write_start:ne {\c_true_bool}{\g__ztikz_python_path_tl/#2}
  }{ 
    \xsim_file_write_stop:   
    \ztikz_hash_if_change_cs:e {\g__ztikz_python_path_tl/\py@file}   
    \bool_if:NTF \g__hash_change_bool {
      \sys_if_platform_windows:TF {
        \ztool_shell_escape:e {
          echo~ plt.savefig('\g__ztikz_python_path_tl/\py@file.pdf')~ >>~ \g__ztikz_python_path_tl/\py@file
        }
      }{
        \ztool_shell_escape:e {
          echo~ "plt.savefig('\g__ztikz_python_path_tl/\py@file.pdf')"~ >>~ \g__ztikz_python_path_tl/\py@file
        }
      }
      \ztool_shell_escape:e {python~ \g__ztikz_python_path_tl/\py@file} 
      \includegraphics[#1]{\g__ztikz_python_path_tl/\py@file.pdf}
      \typeout{Writing~ 'pyfig'~environment~source~to~\tl_use:N \g__ztikz_python_path_tl/\py@file}
    }{
      \includegraphics[#1]{\g__ztikz_python_path_tl/\py@file.pdf}
      \typeout{skip~recompile~by~python,~using~the~cache~picture~\int_use:N \g__python_picture_index_int}
    }
    % step picture index
    \int_gadd:Nn \g__python_picture_index_int {1}
  }
% inline python command
\NewDocumentCommand\py{O{raw}m}
  {
    \ztool_shell_escape:e {sed~ -i~ "6s|Float_res~ =~ .*|Float_res~ =~ \tl_to_str:n {#2}|"~ \g__ztikz_scripts_path_tl/python_script.py}
    \typeout{using~python~float~module~calculating...}
    \ztool_shell_escape:e {python~ \g__ztikz_scripts_path_tl/python_script.py}
    \zlatex_Readlines_cs:ee {#1}{\g__ztikz_python_path_tl/PyFloat.out}
    % ---> cause bug that can't write ToC to file
    % \iow_close:N \g__file_read_ior
  }
% python-sympy
\NewDocumentCommand\sympy{m}
  {
    \int_gadd:Nn \g__sympy_index_int {1}  
    \tl_set:Ne \l__current_sympy_index_tl {\int_use:N \g__sympy_index_int}
    \ztool_shell_escape:e {sed~ -i~ "8s|F_res~ =~ .*|F_res~ =~  #1|"~ \g__ztikz_scripts_path_tl/sympy_script.py}
    \ztikz_hash_if_change_cs:e {\g__ztikz_scripts_path_tl/sympy_script.py}
    \bool_if:NTF \g__hash_change_bool {
      \ztool_shell_escape:e {python~ \g__ztikz_scripts_path_tl/sympy_script.py}
      \ztool_shell_mv:ee
        {\g__ztikz_python_path_tl/sympy.out}
        {\g__ztikz_python_path_tl/sympy_\int_use:N \g__sympy_index_int .out}
      \typeout{using~python~sympy~calculating~question~\l__current_sympy_index_tl ...}
      \exp_args:Ne \input{\g__ztikz_python_path_tl/sympy_\l__current_sympy_index_tl.out}
    }{
      \exp_args:Ne \input{\g__ztikz_python_path_tl/sympy_\l__current_sympy_index_tl.out}
      \typeout{skip~recompile,~using~the~cache~sympy~result~\l__current_sympy_index_tl}
    }
  }
% python-code-env
\NewDocumentEnvironment{pycode}{ m }
  {
    \newcommand{\py@file}{#1}
    \xsim_file_write_start:ne {\c_true_bool}{\g__ztikz_python_path_tl/#1}
  }{ 
    \xsim_file_write_stop: 
    \ztikz_hash_if_change_cs:e {\g__ztikz_python_path_tl/\py@file}   
    \bool_if:NTF \g__hash_change_bool {
      \ztool_shell_escape:e {python~ \g__ztikz_python_path_tl/\py@file} 
      \input{\g__ztikz_python_path_tl/\py@file.out}
      \typeout{Writing~ 'pycode'~environment~source~to~\tl_use:N \g__ztikz_python_path_tl/\py@file}
    }{
      \input{\g__ztikz_python_path_tl/\py@file.out}
      \typeout{skip~recompile~by~python,~using~the~cache~pycode~result~\int_use:N \g__python_picture_index_int}
    }
    \int_gadd:Nn \g__python_picture_index_int {1}  
  }