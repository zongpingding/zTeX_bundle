\ProvidesExplFile{ztikz.library.wolfram.tex}{2024/10/24}{1.0.0}{wolfram~library~for~ztikz}



% ==> init variables
\RequirePackage{xsimverb}
\ztool_shell_mkdir:n {ztikz_output/mma_data/}
\tl_const:Nn \g__ztikz_wolfram_path_tl {ztikz_output/mma_data}
\tl_new:N \l__ztikz_wolfram_tmp_arg_tl
\tl_new:N \l__ztikz_wolfram_tmp_res_tl
\seq_new:N \l__ztikz_wolfram_tmp_res_seq
\int_new:N   \g__ztikz_wolfram_text_index_int
\int_new:N   \g__ztikz_wolfram_picture_index_int
\int_gadd:Nn \g__ztikz_wolfram_text_index_int {1}
\int_gadd:Nn \g__ztikz_wolfram_picture_index_int {1}


% ==> core functions
% macro storage the mma-result
\NewDocumentCommand\wolframResult{O{raw}O{}}
  {
    \tl_if_eq:nnTF {#1}{raw}
      { \seq_use:Nnnn \l__ztikz_wolfram_tmp_res_seq {#2}{#2}{#2}}
      { \if_is_int:eTF {\int_eval:n {#1}}
        {\seq_item:Nn \l__ztikz_wolfram_tmp_res_seq {#1}}{}
      }
  }
% wolfram graphicx
\cs_generate_variant:Nn \xsim_file_write_start:nn {ne}
\NewDocumentEnvironment{wolframGraphics}{ O{width=.75\linewidth}m }
  {
    \newcommand{\mma@file}{#2}
    \xsim_file_write_start:ne {\c_true_bool}{\g__ztikz_wolfram_path_tl/#2}
  }{ 
    \xsim_file_write_stop:  
    \ztikz_hash_if_change_cs:e {\g__ztikz_wolfram_path_tl/\mma@file}   
    \bool_if:NTF \g__hash_change_bool {
      \ztool_shell_escape:e {wolframscript~ -script~ \g__ztikz_wolfram_path_tl/\mma@file} 
      \includegraphics[#1]{\g__ztikz_wolfram_path_tl/\mma@file.pdf}
      \typeout{Writing~ 'mmafig'~environment~source~to~\tl_use:N \g__ztikz_wolfram_path_tl/\mma@file}
    }{
      \includegraphics[#1]{\g__ztikz_wolfram_path_tl/\mma@file.pdf}
      \typeout{skip~recompile~by~wolframscript,~using~the~cache~picture~\int_use:N \g__ztikz_wolfram_picture_index_int}
    }
    \int_gadd:Nn \g__ztikz_wolfram_picture_index_int {1} 
  }
% input result of wolfram
\cs_generate_variant:Nn \ior_open:Nn {Ne}
\cs_new_protected:Nn \ztikz_wolfram_input_result_cs: 
  {
    \iow_now:Ne \g_tmpa_iow {Export["\g__ztikz_wolfram_path_tl/mma_res_\wolfram@text@index.txt", TeXResult]}
    \iow_close:N \g_tmpa_iow
    \ztikz_hash_if_change_cs:e {\g__ztikz_wolfram_path_tl/mma_calc_\wolfram@text@index.wls}   
    \bool_if:NTF \g__hash_change_bool {
      \ztool_shell_escape:e {wolframscript~ -script~ \g__ztikz_wolfram_path_tl/mma_calc_\wolfram@text@index.wls}
      \typeout{using~wolframscript~calculating~question~\wolfram@text@index ...}
    }{
      \typeout{skip~recompile,~using~the~cache~wolframscript~result~\wolfram@text@index}
    }
    \ior_open:Ne \g_tmpa_ior {\g__ztikz_wolfram_path_tl/mma_res_\wolfram@text@index.txt}
    \ior_get:NN  \g_tmpa_ior \l__ztikz_wolfram_tmp_res_tl
    \seq_set_split:NnV \l__ztikz_wolfram_tmp_res_seq{,}\l__ztikz_wolfram_tmp_res_tl
    \int_gadd:Nn \g__ztikz_wolfram_text_index_int {1}  
  }
% wolfram code
\NewDocumentCommand\wolfram{O{tex}m}
  {
    \edef\wolfram@text@index{\int_use:N \g__ztikz_wolfram_text_index_int}
    \iow_open:Ne \g_tmpa_iow {\g__ztikz_wolfram_path_tl/mma_calc_\wolfram@text@index.wls}
    \str_case:nnF {#1}{
      {tex} {
        \iow_now:Ne \g_tmpa_iow { TeXResult = ToString[TeXForm[#2]]; }
      }
      {text} {
        \iow_now:Ne \g_tmpa_iow { TeXResult = ToString[#2]; }
      }
    }{\relax}
    \ztikz_wolfram_input_result_cs:
  }
% equation solve
\NewDocumentCommand\wolframSolve{O{part}mO{}O{}}
  {
    \edef\wolfram@text@index{\int_use:N \g__ztikz_wolfram_text_index_int}
    \tl_if_empty:nTF {#4}
      { \tl_set:Nn \l__ztikz_wolfram_tmp_arg_tl {} }
      { \tl_set:Nn \l__ztikz_wolfram_tmp_arg_tl {,#4} }
    \iow_open:Ne \g_tmpa_iow {\g__ztikz_wolfram_path_tl/mma_calc_\wolfram@text@index.wls}
    \str_case:nnF {#1}{
      {part} {
        \iow_now:Ne \g_tmpa_iow {
          TeXResult = Row[Solve[#2, {#3} \l__ztikz_wolfram_tmp_arg_tl]//Flatten, ","]
                      /.{Rule -> Equal}//TeXForm//ToString;
        }
      }
      {full} {
        \iow_now:Nn \g_tmpa_iow {
          TeXResult = Row[Solve[#2]//Flatten, ","]
                      /.{Rule -> Equal}//TeXForm//ToString;
        }
      }
    }{\relax}
    \ztikz_wolfram_input_result_cs:
  }
% differential equation solve
\NewDocumentCommand\wolframDSolve{O{part}mO{}O{}}
  {
    \edef\wolfram@text@index{\int_use:N \g__ztikz_wolfram_text_index_int}
    \tl_if_empty:nTF {#4}
      { \tl_set:Nn \l__ztikz_wolfram_tmp_arg_tl {} }
      { \tl_set:Nn \l__ztikz_wolfram_tmp_arg_tl {,#4} }
    \iow_open:Ne \g_tmpa_iow {\g__ztikz_wolfram_path_tl/mma_calc_\wolfram@text@index.wls}
    \str_case:nnF {#1}{
      {part} {
        \iow_now:Ne \g_tmpa_iow {
          TeXResult = Row[DSolve[#2, #3 \l__ztikz_wolfram_tmp_arg_tl]//Flatten, ","]
                      /.{Rule -> Equal}//TeXForm//ToString;
        }
      }
      {full} {
        \iow_now:Nn \g_tmpa_iow {
          TeXResult = Row[DSolve[#2]//Flatten, ","]
                      /.{Rule -> Equal}//TeXForm//ToString;
        }
      }
    }{\relax}
    \ztikz_wolfram_input_result_cs:
  }
% check if integer
\prg_new_protected_conditional:Npnn \if_is_int:n #1 { T, F, TF }
  {
    \regex_match:nnTF { ^[\+\-]?[\d]+$ } {#1} 
      { \prg_return_true: }
      { \prg_return_false: }
  }
\cs_generate_variant:Nn \if_is_int:nTF {eTF}