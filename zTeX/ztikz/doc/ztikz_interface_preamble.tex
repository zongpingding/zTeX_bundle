\usepackage{ztool}
\usepackage{ztikz}
\ztexloadlib{alias, thm}
\ztexset{
  toc={
    column  = 2,
    title   = 总目录,
    stretch = 1.3
  }
}
\zcolorset{ link=purple } 
\zthmstyle{leftbar}
\geometry{left=2in, right=1in}
\usepackage{comment}
\usepackage{minted}
\usepackage{longtable}
\usepackage{multicol}
\usepackage{hologo}
\usepackage[bottom]{footmisc}


% ==> l3doc patches
\AtBeginDocument{
  % \DeleteShortVerb \"
  \DeleteShortVerb \|
}
% key-value env for typesetting key-value options
\ExplSyntaxOn
\cs_new_protected:Npn \__codedoc_function_ztex:nnw #1#2
  {
    \__codedoc_function_typeset_start:
    \__codedoc_function_init:
    \tl_set:Nn \l__codedoc_macro_argument_tl {#2}
    \keys_set:nn { l3doc/function } {#1}
    \__codedoc_names_get_seq_ztex:nN {#2} \l__codedoc_names_seq
    \__codedoc_names_parse:
    \__codedoc_function_typeset:
    \__codedoc_function_reset:
    \__codedoc_function_descr_start:w
  }
\cs_new_protected:Npn \__codedoc_names_get_seq_ztex:nN #1#2
  {
    \bool_if:NTF \l__codedoc_names_verb_bool
      {
        \seq_clear:N #2
        \seq_put_right:No #2 { {#1} }
      }
      {
        \tl_set:Nn \l__codedoc_tmpa_tl {#1}
        \tl_remove_all:Ne \l__codedoc_tmpa_tl
          { \exp_not:N \obeyedline \c_percent_str }
        \tl_remove_all:Ne \l__codedoc_tmpa_tl
          { \exp_not:N \obeyedline }
        \__kernel_tl_set:Nx \l__codedoc_tmpa_tl { \l__codedoc_tmpa_tl }
        \tl_remove_all:Ne \l__codedoc_tmpa_tl
          { \iow_char:N \^^M \c_percent_str }
        \tl_remove_all:Ne \l__codedoc_tmpa_tl { \tl_to_str:n { ^ ^ A } }
        \tl_remove_all:Ne \l__codedoc_tmpa_tl { \iow_char:N \^^I }
        \tl_remove_all:Ne \l__codedoc_tmpa_tl { \iow_char:N \^^M }
        \__codedoc_detect_internals:N \l__codedoc_tmpa_tl
        \__codedoc_replace_at_at:N \l__codedoc_tmpa_tl
        \tl_set:Ne \l__codedoc_tmpa_tl 
          { 
            \clist_map_function:NN \l__codedoc_tmpa_tl 
              \__ztex_add_parent_key:n
          }
        \exp_args:NNe \seq_set_from_clist:Nn #2
          { \l__codedoc_tmpa_tl }
      }
  }
\cs_set:Npn \__ztex_add_parent_key:n #1 
  {
    \textcolor{gray}{\l__codedoc_parent_key_ztex_tl/}
    \tl_trim_spaces:n {#1},
  }
\DeclareDocumentEnvironment { keyval } { O{} +m }
  {
    \__codedoc_function_ztex:nnw {#1} {#2}
  }{ 
    \__codedoc_function_end: 
  }
%% catcode hack ref: https://tex.stackexchange.com/a/392770/294585
\cctab_const:Nn \g__ztex_keyval_cctab 
  {
    \cctab_select:N \c_document_cctab
    \char_set_catcode_active:n {124} % '|'
    \char_set_catcode_active:n {62}  % '>'
    \char_set_catcode_letter:n {95}  % '_'
  }
\group_begin:
  \catcode`|=\active
  \catcode`>=\active
  \cs_gset:Nn \__ztex_bar_active: 
    { \def|{\textup{\string|}} }
  \cs_gset:Nn \__ztex_underscore_active: 
    { \def>{\dotfill} }
\group_end:
\DeclareDocumentEnvironment { syntax } { }
  { 
    \cctab_begin:N \g__ztex_keyval_cctab
    \__ztex_bar_active:
    \__ztex_underscore_active:
    \__codedoc_syntax:w 
  }{
    \__codedoc_syntax_end:
    \cctab_end: 
    \ignorespacesafterend
  }
% default value
\gdef\nval{不可设置值}
\newlength{\dvalWidth}
\newlength{\dvalwidth}
\setlength{\dvalWidth}{2.25em}
\setlength{\dvalwidth}{2em}
\gdef\dval{\@ifstar\@@dval\@dval}
\def\@dval#1{初始值:\hb@xt@\dvalWidth{\hfill\textcolor{blue}{\ztool_scale_to_wd:nn {\dvalwidth}{#1}}}}
\def\@@dval#1{初始值:\textcolor{blue}{#1}}
\gdef\vsp{\usefont{OT1}{cmtt}{m}{n}\asciispace}
\ExplSyntaxOff


% ==> logos
\makeatletter
\def\HoLogo@TikZ#1{Ti\textcolor{orange}{\textit{k}}Z}
\def\latex{\hologo{LaTeX}}
\def\ltxee{\hologo{LaTeX2e}}
\makeatother


% ==> source example env
\fvset{gobble=0}
\setmonofont{Latin Modern Mono}
  [
    BoldFont=*,
    ItalicFont=* Slanted,
    BoldItalicFont=* Slanted,
    BoldFeatures={FakeBold=2},
    BoldItalicFeatures={FakeBold=2},
  ]
\definecolor{bg}{rgb}{0.95,0.95,0.95}
\setminted{
  bgcolor=bg,
  breaklines=true, 
  tabsize=2,
  breakanywhere=true,
  breaksymbolright=$\swarrow$,
  breakanywheresymbolpre=,
  breaksymbolleft=,
}
% important: avoid conflict with tikz externalize 'prefix' settings
\tcbuselibrary{external}
\tcbsetforeverylayer{shield externalize} 
\newcounter{DocExample}
\def\exampleUR{\stepcounter{DocExample}\textbf{例\ \theDocExample}}
\def\resetExampleUR{\def\exampleUR{\stepcounter{DocExample}\textbf{例\ \theDocExample}}}
\tcbuselibrary{minted}
\tcbset{listing engine=minted}
\DeclareTCBListing{DocExample}{!s!O{//}}{
  enhanced, 
  breakable,
  % frame hidden, arc=2pt,
  enhanced jigsaw,
  opacityback=0, 
  sharp corners, 
  colframe=black, boxrule=.4pt,
  left=.5mm, right=1mm,
  top=0mm, bottom=0mm, 
  \IfBooleanTF{#1} 
    {listing and text}
    {listing only},
  minted language=tex, 
  minted options = {  
    autogobble,
    escapeinside=#2,
    bgcolor=,
    fontsize=\small,
  },
  overlay unbroken and first = {
    \node[anchor=north east, outer sep=0pt, text=red] 
      at (frame.north east) {\exampleUR};
  }
}


% ==> print ztex source
\ExplSyntaxOn
\clist_new:N \l__ztex_doc_source_clist
\clist_clear:N \l__ztex_doc_source_clist
\cs_set:Npn \__ztex_doc_source:nn #1#2 
  {
    \clist_map_inline:nn {#2}
      {
        \clist_put_right:Nn \l__ztex_doc_source_clist 
          {
            \subsubsection{##1}
            \inputminted{latex}{../code/#1/ztikz.#1.##1.tex}
          }
      }
  }
\newcommand{\inputZTeXSource}[2][module]
  {
    \__ztex_doc_source:nn {#1}{#2}
    \clist_use:Nn \l__ztex_doc_source_clist   
      { \newpage }
    \clist_clear:N \l__ztex_doc_source_clist
  }
\ExplSyntaxOff
\newcommand{\ztexDocPrintSource}{%
  \ztexslideTF{}{
    \section{\texorpdfstring{\textcolor{black}{\ztikz}}{zTikZ} 源码}
    \pagestyle{empty}
    \zpagemask*[anchor=mr, position={(\zpw, .5\zph)}]{{\sffamily\color{gray}\scalebox{5}{\thepage}}}
    \renewcommand{\theFancyVerbLine}{\sffamily
      \textcolor{gray}{\small\oldstylenums{\arabic{FancyVerbLine}}}}
    \setminted{ bgcolor=, linenos=true, numbers=both, texcomments, escapeinside=«» }
    \subsection{ztikz.sty}
    \inputminted{latex}{../code/ztikz.sty}
    \clearpage
    \subsection{Library}
    \inputZTeXSource[library]{basic, gnuplot, cache, python, wolfram}
  }
}


% ==> aux commands
\colorlet{BLACK}{black}
\ztexframe[gray]{leftbar}
\newcommand{\block}[1]{{\color{#1}\rule{1em}{1em}}}
\newcommand{\mstyle}[1]{\noindent\lower.25ex\hbox{\ding{224}}\;\textbf{#1}\par}
\newcommand{\Footnote}[1]{\stepcounter{footnote}\footnote[\thefootnote]{#1}}
\NewDocumentCommand{\zdefault}{sm}{%
  \IfBooleanTF{#1}%
    {\textcolor{red}{\textbf{#2}}}%
    {\textcolor{red}{:\textbf{#2}}}%
}
\ExplSyntaxOn
\newcommand{\zarg}[1]{\texttt{\{} #1 \texttt{\}}}
\newcommand{\zkey}[1]{
  \clist_clear:N \l_tmpa_clist
  \clist_map_inline:nn {#1}{
    \clist_put_right:Nn \l_tmpa_clist {\meta{##1}}
  }
  \clist_use:Nn \l_tmpa_clist {,~}
}
\def\sineData{./support/data/sine.data}
\ExplSyntaxOff


% todo list
% REF: https://tex.stackexchange.com/q/247681/294585
% syntax:
%     *: wont fix
%     [<arg>]: done
%     [<blank>]: undone
\usepackage{enumitem}
\newlist{todolist}{itemize}{2}
\setlist[todolist]{label=\checkmark}
\usepackage{amssymb}
\newcommand{\done}{\rlap{\raisebox{0.3ex}{\hspace{0.4ex}\tiny \ding{52}}}$\square$}
\newcommand{\undone}{$\square$}
\newcommand{\wontfix}{\rlap{\raisebox{0.3ex}{\hspace{0.4ex}\scriptsize \ding{56}}}$\square$}
