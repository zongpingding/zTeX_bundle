\ProvidesExplFile{zlatex.module.thm.tex}{2024/12/17}{1.0.0}{thm~module~for~zlatex}


%%%%%     Math-envs for zlatex     %%%%%
% ==> module init
\clist_gclear:N \g__zlatex_thm_theorem_clist
\clist_gclear:N \g__zlatex_thm_proof_clist
\cs_new_protected:Npn \zlatex_thm_create:nn #1#2 {
  \clist_gput_right:cn {g__zlatex_thm_#1_clist}{#2}
}
\cs_generate_variant:Nn \zlatex_thm_create:nn {ne}
\zlatex_thm_create:nn {theorem}{ 
  axiom, definition, theorem, lemma, corollary, proposition, remark,
}
\zlatex_thm_create:nn {proof}{ 
  proof, exercise, example, solution, problem,  
}
\zlatex_msg_set:nn {thm-name}
  {An~unexpected~math~env~name~in~multichoice~key:'\l_keys_key_tl',~there~is~no~internal~config~for~it.}

% thm title definition
\cs_new_protected:Npn \zlatex_thm_name_set:nn #1#2 {
  \prop_set_from_keyval:cn {g__zlatex_thm_name_#1_prop} {#2}
}
\zlatex_thm_name_set:nn {en}{
  axiom       = Axiom, 
  definition  = Definition, 
  theorem     = Theorem, 
  lemma       = Lemma, 
  corollary   = Corollary, 
  proposition = Proposition, 
  remark      = Remark, 
  proof       = Proof, 
  exercise    = Exercise, 
  example     = Example, 
  solution    = Solution, 
  problem     = Problem,
}
\zlatex_thm_name_set:nn {cn}{
  axiom       = 公理, 
  definition  = 定义, 
  theorem     = 定理, 
  lemma       = 引理, 
  corollary   = 推论, 
  proposition = 命题, 
  remark      = 注记, 
  proof       = 证明, 
  exercise    = 练习, 
  example     = 示例, 
  solution    = 解, 
  problem     = 问题,
}
\zlatex_thm_name_set:nn {fr}{
  axiom       = Axiome, 
  definition  = Définition, 
  theorem     = Théorème, 
  lemma       = Lemme, 
  corollary   = Corollaire, 
  proposition = Proposition, 
  remark      = Remarque, 
  proof       = Preuve, 
  exercise    = Exercice, 
  example     = Exemple, 
  solution    = Solution, 
  problem     = Problème,
}
\tl_if_exist:NF \g__zlatex_lang_math_tl {
  \tl_set_eq:cc {g__zlatex_lang_math_tl}{g__zlatex_lang_str}
}


% ==> thm module tools
\NewDocumentCommand{\zlatexThmLang}{m}{
  \tl_gset:Nn \g__zlatex_lang_math_tl {#1}
  \prop_set_eq:cc 
    {g__zlatex_thm_name_prop}
    {g__zlatex_thm_name_\g__zlatex_lang_math_tl _prop}
}
\prop_new:c {g__zlatex_thm_name_prop}
\prop_gclear:c {g__zlatex_thm_name_prop}
\zlatex_hook_preamble_last:n {
  \prop_set_eq:cc {g__zlatex_thm_name_prop}
                  {g__zlatex_thm_name_\g__zlatex_lang_math_tl _prop}
}
\tl_new:N \g__zlatex_thm_title_tl
\NewDocumentCommand{\zlatexThmTitle}{}{
  \tl_use:N \g__zlatex_thm_title_tl
}
\bool_new:N \g__zlatex_thm_title_inline_bool
\NewDocumentCommand{\zlatexThmTitleSwitch}{}{
  \bool_gset_inverse:N \g__zlatex_thm_title_inline_bool
}
\NewDocumentCommand{\zlatexThmColorSetup}{m}{
  \zlatex_keys_set:nn {color}{#1}
}
% create new thm env
\cs_new:Npn \__zlatex_mid_first:w #1|#2\q_stop {#1}
\cs_new:Npn \__zlatex_thm_color_set:w #1\q_stop #2|#3\q_stop 
  { 
    \tl_if_empty:eTF {#3}
      {\zlatex_keys_set:nn {color}{#1=black}} 
      {\zlatex_keys_set:nn {color}{#1=#3}} 
  }
\cs_new:Npn \__zlatex_color_keyval_add:n #1 {
  \zlatex_keys_define:nn {color}{
    #1 .tl_set:c  = { l__zlatex_#1_color_tl },
    #1 .initial:n = { black },
    #1 .code:n    = { \__zlatex_color_set:n {##1} },
  }
}
\cs_new:Npn \__zlatex_thm_create__:nn #1#2 {
  \zlatex_thm_create:nn {#1}{#2}
  \__zlatex_color_keyval_add:n {#2}
  \prop_gput_from_keyval:cn {g__zlatex_thm_name_prop}{#2=#2}
}
\cs_new:Npn \__zlatex_thm_create__:nnn #1#2#3 { 
  \zlatex_thm_create:ne {#1}{\use_i:nn {#2}{#3}}
  \__zlatex_color_keyval_add:n {#2}
  \exp_last_unbraced:Ne \__zlatex_thm_color_set:w #2\q_stop #3\q_stop
  \prop_gput:cee {g__zlatex_thm_name_prop}
    {#2}{\exp_last_unbraced:Ne \__zlatex_mid_first:w #3\q_stop}
}
\NewDocumentCommand{\zlatexThmCreate}{mm}{
  \zlatex_label_hook_preamble_last:nn {zlatex-thmall-setup-user}{
  \keyval_parse:nnn
    { \__zlatex_thm_create__:nn {#1} }
    { \__zlatex_thm_create__:nnn {#1} }
    { #2 }
  }
}
% \@onlypreamble\zlatexThmCreate


% ==> new thm style interface
\NewDocumentCommand{\zlatexThmStyleNew}{+m}{
  \keyval_parse:nnn
    {\use_none:n}
    {\__zlatex_thm_new_style:nn} 
    {#1}
}
\cs_new_protected:Npn \__zlatex_thm_new_style:nn #1#2 {
  \zlatex_keys_define:nn { thm/style } {
    #1            .meta:nn   = { zlatex/thm/style/#1 }{##1},
    #1 / begin    .tl_gset:c = { g__zlatex_thm_style_#1_begin_tl },
    #1 / end      .tl_gset:c = { g__zlatex_thm_style_#1_end_tl },
    #1 / option   .tl_gset:c = { g__zlatex_thm_style_#1_option_tl }, 
    #1 / preamble .code:n    = { 
      % NOTE:
      % 1. thm preamble can be only set by one style
      % 2. '\g__zlatex_thm_style_tl' need to be set 
      %       before '\zlatexloadlibrary{theme}'
      \tl_if_eq:cnT {g__zlatex_thm_style_tl}{#1}{
        % \hook_gremove_code:nn {env/document/before}{zlatex-thm-preamble}
        \zlatex_label_hook_preamble_last:nn 
          {zlatex-thm-preamble}{##1} 
      }
    },
  }
  \zlatex_keys_set:nn { thm/style }{ #1={#2} }
}
\NewDocumentCommand{\zlatexThmStyle}{m}{
  \tl_gset:Nn \g__zlatex_thm_style_tl {#1}
}
% title switch and tcb warning, create thm styles
\cs_new:Npn \__zlatex_thm_title_inline:n #1 {
  \tl_if_eq:nnTF {#1}{T}
    {\bool_gset_true:N \g__zlatex_thm_title_inline_bool}
    {\bool_gset_false:N \g__zlatex_thm_title_inline_bool}
}
% tcolorbox and tikz warning if missing 
%             when create new thm style
\zlatex_msg_set:nn {mathEnv-dependency}{
  MathEnv~style:'\g__zlatex_thm_style_tl'~requires~package~'tcolorbox'~and~'tikz',~and~
  either~of~which~hasn't~been~loaded~in~your~preamble.~Reset~to~default~'plain'~style~now.
}
\cs_new:Nn \__zlatex_thm_tcolorbox_warning: {
  \@ifpackageloaded{tcolorbox}{\relax}{
    \zlatex_msg_warn:n {mathEnv-dependency}
    \tl_gset:Nn \g__zlatex_thm_style_tl {plain}
  }
}
\zlatexThmStyleNew {
  plain = {
    begin  =, 
    end    =, 
    option = \__zlatex_thm_title_inline:n {T}
  },
  leftbar = {
    begin = {
      \def\FrameCommand{{\color{\thm@temp@color}\vrule~ width~ 3pt}
      \hspace{5pt}}\MakeFramed{\advance\hsize-\width \FrameRestore}
    },
    end = {\endMakeFramed},
    option = { \__zlatex_thm_title_inline:n {T} }
  },
  background = {
    begin = {
      \def\FrameCommand{\colorbox{\thm@temp@color}}
      \MakeFramed{\advance\hsize-\width \FrameRestore}
    },
    end = {\endMakeFramed},
    option = { \__zlatex_thm_title_inline:n {T} }
  },
  fancy = {
    begin = {
      \def\FrameCommand{{\color{\thm@temp@color}\vrule~ width~ 3pt}\colorbox{\thm@temp@color!10}}
      \MakeFramed{\advance\hsize-\width \FrameRestore}
    },
    end = {\endMakeFramed},
    option = { \__zlatex_thm_title_inline:n {T} }
  },
}


% ==> thm format and style setup
\zlatex_msg_set:nn {mathEnv-style}{
  You~use~an~incorrect~MathEnv~style:~'\g__zlatex_thm_style_tl',~All~valid~
  MathEnv~are:'plain',~'leftbar',~'ba\zlatexThmNameckground',~'fancy',~'shadow',~'paris'.
}
% thm counter
\bool_new:N \g__zlatex_thm_cntshare_bool
\zlatex_keys_define:nn {thm/cnt} {
  share     .bool_gset:N = \g__zlatex_thm_cntshare_bool,
  share     .default:n   = true,
  parent    .tl_gset:N   = \g__zlatex_thm_cntparent_tl,
  parent    .initial:n   = section,
}
\NewDocumentCommand{\zlatexThmCnt}{m}{
  \group_begin:
    \zlatex_keys_set:nn {thm/cnt}{#1}
  \group_end:
}
\@onlypreamble\zlatexThmCnt
% thm env warper
\cs_new:Npn \__zlatex_thm_warp_start:nnnn #1#2#3#4 {
  \def\thm@temp@color{\tl_use:c {l__zlatex_#1_color_tl}}
  \def\thm@temp@name{#1}
  \__zlatex_thm_title_item:nnnn {#1}{#2}{#3}{#4}
  \tl_use:c {g__zlatex_thm_style_\g__zlatex_thm_style_tl _option_tl}
  \tl_if_exist:cTF {g__zlatex_thm_style_\g__zlatex_thm_style_tl _begin_tl}
    {\tl_use:c {g__zlatex_thm_style_\g__zlatex_thm_style_tl _begin_tl}}
    {\zlatex_msg_error:n {mathEnv-style}}
}
\tl_new:N \__zlatex_thm_toc_prefix_tl
\newcommand\zlatexThmTocPrefix[1]{
  \tl_set:Nn \__zlatex_thm_toc_prefix_tl {\exp_not:n {#1}}
}
\@onlypreamble\zlatexThmTocPrefix
\cs_new:Npn \__zlatex_thm_warp_end:n #1 
  {
    \tl_use:c {g__zlatex_thm_style_\g__zlatex_thm_style_tl _end_tl}
    \__zlatex_thm_toc_add:eeee 
      {\g__zlatex_thm_table_level}
      { 
        \exp_not:N \__zlatex_thm_toc_prefix_tl
        \exp_not:n {\prop_item:Nn \g_zlatex_thm_toc_symbols_prop {#1}}
        \zlatexThmName\ \zlatexThmNumber
        \tl_if_empty:eF {\zlatexThmNote{}{}}{\ }
        \zlatexThmNote{(}{)}
      }
      {\thepage}{#1.\zlatexThmNumber}
  }
% thm title interface
\NewHook{zlatex/thm/titleformat}
\cs_new:Npn \__zlatex_thm_title_item:nnnn #1#2#3#4 {
  \tl_set:Nn \l_tmpa_tl {\exp_not:n {#2}}
  \cs_set:Npn \zlatexThmName {
    % \textcolor{\tl_use:c {l__zlatex_#1_color_tl}}
      {\prop_item:cn {g__zlatex_thm_name_prop}{#1}}
    }
  \cs_set:Npn \zlatexThmNote ##1##2
    {
      \tl_if_empty:nF {#2}
        {##1\exp_not:n {\l_tmpa_tl}##2}
    }
  \bool_if:NTF \g__zlatex_thm_cntshare_bool
    {\cs_set:Npn \zlatexThmNumber {
      \cs:w the\g__zlatex_thm_cntparent_tl\cs_end:
        .\cs:w thezlatex@thm@sharecnt\cs_end:}
      \stepcounter{zlatex@thm@sharecnt}
    }{\cs_set:Npn \zlatexThmNumber {
      \cs:w the\g__zlatex_thm_cntparent_tl\cs_end:
        .\cs:w the#1\cs_end:}
      \stepcounter{#1}
    }
  \tl_gset:Nn \g__zlatex_thm_title_tl {
    #3\zlatexThmName #4 \zlatexThmNumber
    \tl_if_empty:eF {\zlatexThmNote{}{}}{#4}
    \zlatexThmNote{(}{)} #4
  }
  \UseHook{zlatex/thm/titleformat}
}
\cs_new:Npn \__zlatex_thm_title: {
  \bool_if:NT \g__zlatex_thm_title_inline_bool
    {\group_begin:\noindent\tl_use:N \g__zlatex_thm_title_tl\group_end:}
}
% users' interface of thm title format
\NewDocumentCommand{\zlatexThmTitleFormat}{sm}{
  \IfBooleanTF{#1}{
    \AddToHook{zlatex/thm/titleformat}
      {\tl_gset:Nn \g__zlatex_thm_title_tl {#2}}
  }{
    \AddToHookNext{zlatex/thm/titleformat}
      {\tl_gset:Nn \g__zlatex_thm_title_tl {#2}}
  }
}
\NewDocumentCommand{\zlatexThmNoteEmptyTF}{mm}
  {
    \tl_if_empty:eTF {\zlatexThmNote{}{}}
      {#1}
      {#2}
  }


% ==> Thm Toc interface
% list of thm: ".thlist" as file extension
% REF: https://github.com/mbertucci47/keytheorems
\bool_new:N \g__zlatex_thm_toc_bool
\hook_gput_code:nnn { enddocument } { thm-toc }
  {
    \bool_if:NT \g__zlatex_thm_toc_bool {
      \iow_new:N \tf@thlist
      \iow_open:Nn \tf@thlist { \c_sys_jobname_str.thlist }
    }
  }
\cs_new:Npn \__zlatex_thm_toc_add:nnnn #1#2#3#4 
  {
    \iow_now:Ne \@auxout 
      {
        \token_to_str:N \@writefile{thlist}
          {\token_to_str:N \contentsline{#1}{#2}{#3}{#4}
          \token_to_str:N \protected@file@percent}
      }
  }
\cs_generate_variant:Nn \__zlatex_thm_toc_add:nnnn { eeee, nnee }
\zlatex_keys_define:nn { thm/add }
  {
    % level   .tl_set:N  = \l__zlatex_add_thm_toc_level_tl,
    % level   .initial:n = { section },
    name      .tl_set:N  = \l__zlatex_add_thm_toc_name_tl,
    name      .initial:n = { ?? },
  }
\NewDocumentCommand{\zlatexThmTocAdd}{om}{
  \group_begin:
  \zlatex_keys_set:nn {thm/add}{#1}
  \__zlatex_thm_toc_add:nnee {#2}
    {\l__zlatex_add_thm_toc_name_tl}
    {\thepage}{#2.\cs:w the#2\cs_end:}
  \group_end:
}
\tl_new:N \g__zlatex_thm_table_level
\tl_set:Nn \g__zlatex_thm_table_level {subsection}
\NewDocumentCommand{\zlatexThmTocLevel}{m}
  {
    \tl_gset:Nn \g__zlatex_thm_table_level {#1}
  }
\@onlypreamble\zlatexThmTocLevel
\NewDocumentCommand{\zlatexThmToc}{O{1}}
  {
    \bool_gset_true:N \g__zlatex_thm_toc_bool
    \group_begin:
    \legacy_if_set_false:n { @filesw }  
    \renewcommand{\baselinestretch}{#1}\normalsize 
    \@input{\jobname.thlist}
    \group_end:
  }
% thm toc symbols
\prop_new:N \g_zlatex_thm_toc_symbols_prop 
\prop_set_from_keyval:Nn \g_zlatex_thm_toc_symbols_prop
  {
    axiom       = { \textbf{A}\; },
    definition  = { \textbf{D}\; },
    theorem     = { \textbf{T}\; },
    lemma       = { \textbf{L}\; },
    corollary   = { \textbf{C}\; },
    proposition = { \textbf{P}\; },
    remark      = { \textbf{R}\; },
  }
\NewDocumentCommand{\zlatexThmTocSymbol}{m}
  {
    \prop_set_from_keyval:Nn \g_zlatex_thm_toc_symbols_prop {#1}
  }
\NewDocumentCommand{\zlatexThmTocSymbolClear}{}
  { \prop_gclear:N \g_zlatex_thm_toc_symbols_prop }


% ==> thm env definition
\NewHook{zlatex/thm/before}
\NewHook{zlatex/thm/begin}
\NewReversedHook{zlatex/thm/end}
\NewReversedHook{zlatex/thm/after}
\zlatex_label_hook_preamble_last:nn {zlatex-thmptheorem-setup-inner}{
  \newcounter{zlatex@thm@sharecnt}[\g__zlatex_thm_cntparent_tl]
  \clist_map_inline:Nn \g__zlatex_thm_theorem_clist {
    \newcounter{#1}[\g__zlatex_thm_cntparent_tl]
    \__zlatex_cref_math_env:n {#1}
    \DeclareDocumentEnvironment{#1}{O{}}{
      \UseHook{zlatex/thm/before}
      \__zlatex_thm_warp_start:nnnn {#1}{##1}{\bfseries}{\ }
      \MakeLinkTarget*{#1.\zlatexThmNumber}\__zlatex_thm_title:   
      \UseHook{zlatex/thm/begin}
      \peek_remove_spaces:n             
    }{
      \UseHook{zlatex/thm/end}
      \__zlatex_thm_warp_end:n {#1}
      \UseHook{zlatex/thm/after}
    }
  }
}
\newcommand{\qedsymbol}{\ensuremath{\square}}
\zlatex_label_hook_preamble_last:nn {zlatex-thmprooof-setup-inner}{
  \clist_map_inline:Nn \g__zlatex_thm_proof_clist {
    \DeclareDocumentEnvironment{#1}{O{}}{
      \noindent{\color{\tl_use:c {l__zlatex_#1_color_tl}}
      \bfseries\prop_item:cn {g__zlatex_thm_name_prop}{#1}:}
      \tl_set:Nn \l__arg_one_tl {#1}
    }{\str_if_eq:VnTF \l__arg_one_tl {proof}{\hfill\qedsymbol\par}{\par}}
  }
}
% zlatex thm hook
\int_new:N \g__zlatex_thm_hook_index_int
\int_gzero:N \g__zlatex_thm_hook_index_int
\cs_generate_variant:Nn \hook_gput_code:nnn {ne}
\NewDocumentCommand{\zlatexThmHook}{sm}{
  \IfBooleanTF{#1}
    {
      \cs_set:Npn \__zlatex_hook_add:nn ##1##2
        {
          \int_gincr:N \g__zlatex_thm_hook_index_int
          \hook_gput_code:nen {zlatex/thm/##1}
            {thm-hook.\int_use:N \g__zlatex_thm_hook_index_int}{##2}
        }
    }{
      \cs_set:Npn \__zlatex_hook_add:nn ##1##2
        {
          \int_gincr:N \g__zlatex_thm_hook_index_int
          \hook_gput_next_code:nn {zlatex/thm/##1}{##2} 
        }
    }
  \keyval_parse:NNn 
    \use_none:n
    \__zlatex_hook_add:nn {#2}
}
\hook_gput_code:nnn {zlatex/thm/before}{thm-before-par}{\par}
\NewDocumentCommand{\zlatexThmBefore}{+m}
  {
    \hook_gremove_code:nn {zlatex/thm/before}{thm-before-par}
    \hook_gput_code:nnn {zlatex/thm/before}{thm-before-par}{#1}
  }
\@onlypreamble\zlatexThmBefore
\DeclareHookRule{env/document/before}
  {zlatex-thmall-setup-user}{<}{zlatex-thmptheorem-setup-inner}
\DeclareHookRule{env/document/before}
  {zlatex-thmall-setup-user}{<}{zlatex-thmprooof-setup-inner}
