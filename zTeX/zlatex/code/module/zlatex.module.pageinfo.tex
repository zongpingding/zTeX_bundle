\ProvidesExplFile{zlatex.module.pageinfo.tex}{2025/01/20}{1.0.1}{pageinfo~module~for~zlatex}


%%%%%     pageinfo module for zlatex     %%%%%
% TODO: implement this by new mark mechanism


% ==> fancy page settings
\bool_if:NF \g__zlatex_slide_bool {
  \RequirePackage{fancyhdr}
  \fancypagestyle{fancy}{
    \fancyhf{}  
    \dim_gset:Nn \headheight{15pt}
    \renewcommand{\headrule}{\hrule width\textwidth}
    \if@twoside
      \fancyhead[EL]{\leftmark}
      \fancyhead[ER]{\thepage}
      \fancyhead[OL]{\thepage}
      \fancyhead[OR]{\rightmark}
    \else
      \IfClassLoadedTF{book}{
        \fancyhead[L]{\thepage}
        \fancyhead[R]{\rightmark}
      }{
        \fancyhead[L]{\thepage}
        \fancyhead[R]{\leftmark}
      }
    \fi
  }
  \fancypagestyle{plain}{
    \fancyhf{}  
    \renewcommand{\headrulewidth}{0pt}
    \renewcommand{\headrule}{}
    \fancyfoot[C]{\thepage}
  }
}


% ==> front/main matter
\IfClassLoadedTF{book}{
  \renewcommand\frontmatter{
    \cleardoublepage
    \pagestyle{plain}
    \@mainmatterfalse
    \pagenumbering{Roman}
  }
  \renewcommand\mainmatter{
    \cleardoublepage
    \pagestyle{fancy}
    \@mainmattertrue
    \pagenumbering{arabic}
  }
}{
  \bool_if:NF \g__zlatex_slide_bool 
    {\zlatex_hook_preamble_last:n {\pagestyle{fancy}}}
}


% ==> title page
\let\orimaketitle\maketitle
\newcommand\Maketitle[1][1in]{
  \newgeometry{margin=#1}
  \orimaketitle
  \restoregeometry
}
\bool_if:NTF \g__zlatex_slide_bool {
  \renewcommand\maketitle{
    \bool_if:NT \g__zlatex_hyperref_bool {
      \phantomsection
      \hypertarget{zslide-title-page}{}
    }
    \newgeometry{margin=1cm}
    \null\vfill\begin{center}
      \begin{tabular}{c}{\huge\zslideTitle}\\[2em]
      \zslideAuthor\\[2em]\zslideDate\end{tabular}
    \end{center}\vfill\null
    \thispagestyle{empty}\setcounter{page}{0}
    \restoregeometry
  }
}{
  \renewcommand{\maketitle}{
    \thispagestyle{empty}
    % calc max width, add '1pt' for right padding in case of wrong line break
    \ztool_get_wd:Nn \l_tmpa_dim {\hbox:n {\huge\bfseries\@title}}
    \ztool_get_wd:Nn \l_tmpb_dim {\hbox:n {\Large\bfseries\@author}}
    \dim_set:Nn \l_tmpa_dim {\dim_max:nn {\l_tmpa_dim}{\l_tmpb_dim} + 1pt}
    % typeset info
    \begin{center}\vfill\vspace*{40pt}
    \rule{6pt}{80pt}\enskip
    \parbox[b][80pt][r]{\l_tmpa_dim}{
      {\huge\bfseries\@title}\\[\fill]
      {\Large\bfseries\@author}
    }
    \par\vfill{\Large\textcolor{gray}{\@date}}
    \end{center}
  }
}


% ==> page annotation
% #1: fore/background; #2: position; 
% #3: anchor;          #4: object
% #5: hook range
% \RequirePackage{transparent}
\dim_const:Nn \zph {\paperheight}
\dim_const:Nn \zpw {\paperwidth}
\cs_generate_variant:Nn \hook_gput_code:nnn {nne}
\cs_new_protected:Npn \__zlatex_page_annotate:nnnnn #1#2#3#4#5
  {
    \tl_if_empty:eTF {#5}
      {
        \hook_gput_code:nnn {shipout/#1}
          {zlatex@page@mask-\l__zlatex_page_mask_label_tl}
          {\put#2{\makebox(0, 0)[#3]{#4}}}
      }{
        \hook_gput_next_code:nn {shipout/#1}
          {\put#2{\makebox(0, 0)[#3]{#4}}}
      }
  }
\DeclareHookRule{shipout/background}{.}{<}{pgfrcs}
\zlatex_keys_define:nn { page/mask }{
  layer    .tl_set:N  = \l__zlatex_page_mask_layer_tl,
  layer    .initial:n = background,
  position .tl_set:N  = \l__zlatex_page_mask_position_tl,
  position .initial:n = {(.5\zpw, .5\zph)},
  anchor   .tl_set:N  = \l__zlatex_page_mask_anchor_tl,
  anchor   .initial:n = c,
  label    .tl_set:N  = \l__zlatex_page_mask_label_tl,
  label    .initial:n = { DEFAULT },
}
\cs_generate_variant:Nn \__zlatex_page_annotate:nnnnn {eee}
\cs_new:Npn \__page_mask@pos_parse:w (#1, #2) 
  {(
    \dim_to_decimal:n {#1} pt, 
    \dim_to_decimal:n {#2-\paperheight} pt
  )}
\zlatex_msg_set:nn {pageinfo}{Only~star~version~of~\string\zlatexPageMask\ is~label-allowed.}
\NewDocumentCommand{\zlatexPageMask}{so+m}
  {
    \group_begin:
    \IfValueT{#2}{\zlatex_keys_set:nn { page/mask }{#2}}
    \IfBooleanTF{#1}{\gdef\@once@hook@sign{}}{
      \gdef\@once@hook@sign{*}
      \tl_if_eq:enF {\l__zlatex_page_mask_label_tl}
        { DEFAULT }
        { \zlatex_msg_warn:n {pageinfo} }
    }
    \exp_args:Neee \DeclareHookRule{shipout/\l__zlatex_page_mask_layer_tl}
      {zlatex@page@mask-\l__zlatex_page_mask_label_tl}
      {<}{pgfrcs}
    \__zlatex_page_annotate:eeenn 
      {\l__zlatex_page_mask_layer_tl}
      {\exp_after:wN \__page_mask@pos_parse:w \l__zlatex_page_mask_position_tl}
      {\l__zlatex_page_mask_anchor_tl}{#3}
      {\@once@hook@sign}
    \group_end:
  }
\NewDocumentCommand{\zlatexPageMaskRemove}{mm}
  {
    \hook_gremove_code:nn {shipout/#1}
      {zlatex@page@mask-#2}
  }



% ==> page target
\AddToHook{shipout/firstpage}{
  \label{zlatex-title-page}
  \hyper@anchor{zlatex@titlepage}
}
\AddToHook{shipout/lastpage}{
  \label{zlatex-last-page}
  \hyper@anchor{zlatex@lastpage}
}



% ==> doc info
\zlatex_hook_preamble_last:n {
  \let\zlatexTitle\@title
  \let\zlatexAuthor\@author
  \let\zlatexDate\@date
}